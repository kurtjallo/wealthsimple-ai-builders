---
phase: 07-agent-visualization
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/components/pipeline/agent-status-card.tsx
  - src/components/pipeline/agent-pipeline-view.tsx
  - src/components/pipeline/pipeline-stage-indicator.tsx
  - src/components/pipeline/agent-status-badge.tsx
autonomous: true

must_haves:
  truths:
    - "Each agent is represented as a visual card showing its name, status, confidence, and duration"
    - "The pipeline view shows agents arranged in their execution order with parallel agents side-by-side"
    - "Running agents have a visible animated indicator distinguishing them from pending/completed"
    - "Parallel execution of identity_verifier and sanctions_screener is visually obvious (same row, both animating)"
    - "Completed agents show confidence percentage and processing time"
    - "Failed agents show error state with the error message"
  artifacts:
    - path: "src/components/pipeline/agent-status-card.tsx"
      provides: "Individual agent card component with status, confidence, timing display"
      exports: ["AgentStatusCard"]
    - path: "src/components/pipeline/agent-pipeline-view.tsx"
      provides: "Full pipeline visualization layout — orchestrates all agent cards in workflow order"
      exports: ["AgentPipelineView"]
    - path: "src/components/pipeline/pipeline-stage-indicator.tsx"
      provides: "Stage progress indicator showing current pipeline position"
      exports: ["PipelineStageIndicator"]
    - path: "src/components/pipeline/agent-status-badge.tsx"
      provides: "Status badge component with color-coded states"
      exports: ["AgentStatusBadge"]
  key_links:
    - from: "src/components/pipeline/agent-pipeline-view.tsx"
      to: "src/lib/hooks/use-agent-status.ts"
      via: "consumes AgentStatusInfo[] for rendering"
      pattern: "import.*AgentStatusInfo.*from.*use-agent-status"
    - from: "src/components/pipeline/agent-pipeline-view.tsx"
      to: "src/components/pipeline/agent-status-card.tsx"
      via: "renders one AgentStatusCard per agent"
      pattern: "import.*AgentStatusCard"
    - from: "src/components/pipeline/agent-status-card.tsx"
      to: "src/components/pipeline/agent-status-badge.tsx"
      via: "renders status badge inside card"
      pattern: "import.*AgentStatusBadge"
---

<objective>
Build the agent pipeline visualization components — the visual representation of agents processing a case in real-time. This is the centerpiece UI that shows agents working in parallel, transitioning through statuses, and completing with results.

Purpose: This is what sells the "3 minutes vs 5 days" narrative. The compliance officer (and the demo viewer) needs to SEE agents working simultaneously. The pipeline view is a workflow diagram: Document Processing -> [Identity Verification | Sanctions Screening] (parallel) -> Risk Scoring -> Case Narrative. Each agent card shows live status, and when processing completes, confidence and timing appear.

Output: Four React components that compose into a full pipeline visualization widget, ready for animation (Plan 03) and polish (Plan 04).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-agent-visualization/07-01-SUMMARY.md
@src/lib/hooks/use-agent-status.ts (AgentStatusInfo)
@src/lib/hooks/use-pipeline-stream.ts (PipelineUpdate, StreamStatus)
@src/components/ui/card.tsx (Card, CardHeader, CardContent)
@src/components/ui/badge.tsx (Badge)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create agent status badge and individual agent status card</name>
  <files>src/components/pipeline/agent-status-badge.tsx, src/components/pipeline/agent-status-card.tsx</files>
  <action>
    1. Create `src/components/pipeline/agent-status-badge.tsx` — color-coded status badge:

       ```typescript
       'use client';

       import { Badge } from '@/components/ui/badge';
       import { AgentRunStatus } from '@/types';
       import { cn } from '@/lib/utils';

       interface AgentStatusBadgeProps {
         status: AgentRunStatus;
         className?: string;
       }

       const STATUS_CONFIG: Record<AgentRunStatus, {
         label: string;
         variant: 'default' | 'secondary' | 'destructive' | 'outline';
         className: string;
       }> = {
         pending: {
           label: 'Pending',
           variant: 'outline',
           className: 'border-slate-300 text-slate-500 bg-slate-50',
         },
         running: {
           label: 'Running',
           variant: 'default',
           className: 'bg-blue-500 text-white border-blue-600 animate-pulse',
         },
         completed: {
           label: 'Complete',
           variant: 'default',
           className: 'bg-emerald-500 text-white border-emerald-600',
         },
         failed: {
           label: 'Failed',
           variant: 'destructive',
           className: 'bg-red-500 text-white border-red-600',
         },
       };

       export function AgentStatusBadge({ status, className }: AgentStatusBadgeProps) {
         const config = STATUS_CONFIG[status];

         return (
           <Badge
             variant={config.variant}
             className={cn(config.className, className)}
           >
             {status === 'running' && (
               <span className="mr-1.5 inline-block h-2 w-2 rounded-full bg-white animate-pulse" />
             )}
             {config.label}
           </Badge>
         );
       }
       ```

    2. Create `src/components/pipeline/agent-status-card.tsx` — individual agent card:

       ```typescript
       'use client';

       import { Card, CardContent, CardHeader } from '@/components/ui/card';
       import { AgentStatusBadge } from './agent-status-badge';
       import { cn } from '@/lib/utils';
       import { AgentRunStatus } from '@/types';
       import {
         FileText,
         UserCheck,
         ShieldAlert,
         BarChart3,
         FileEdit,
         type LucideIcon,
       } from 'lucide-react';

       interface AgentStatusCardProps {
         label: string;
         description: string;
         agentType: string;
         status: AgentRunStatus;
         confidence: number | null;
         durationMs: number | null;
         error: string | null;
         className?: string;
       }

       // Icon mapping for each agent type
       const AGENT_ICONS: Record<string, LucideIcon> = {
         document_processor: FileText,
         identity_verifier: UserCheck,
         sanctions_screener: ShieldAlert,
         risk_scorer: BarChart3,
         case_narrator: FileEdit,
       };

       // Border color based on status
       const STATUS_BORDER: Record<AgentRunStatus, string> = {
         pending: 'border-slate-200',
         running: 'border-blue-400 shadow-blue-100 shadow-md',
         completed: 'border-emerald-400 shadow-emerald-100 shadow-sm',
         failed: 'border-red-400 shadow-red-100 shadow-sm',
       };

       export function AgentStatusCard({
         label,
         description,
         agentType,
         status,
         confidence,
         durationMs,
         error,
         className,
       }: AgentStatusCardProps) {
         const Icon = AGENT_ICONS[agentType] || FileText;

         return (
           <Card
             className={cn(
               'relative overflow-hidden transition-all duration-500',
               STATUS_BORDER[status],
               status === 'running' && 'ring-2 ring-blue-200 ring-offset-1',
               status === 'pending' && 'opacity-60',
               className,
             )}
           >
             {/* Progress bar for running state */}
             {status === 'running' && (
               <div className="absolute top-0 left-0 h-1 w-full overflow-hidden bg-blue-100">
                 <div className="h-full w-1/3 animate-[shimmer_1.5s_ease-in-out_infinite] bg-gradient-to-r from-transparent via-blue-500 to-transparent" />
               </div>
             )}

             {/* Success bar for completed state */}
             {status === 'completed' && (
               <div className="absolute top-0 left-0 h-1 w-full bg-emerald-500" />
             )}

             {/* Error bar for failed state */}
             {status === 'failed' && (
               <div className="absolute top-0 left-0 h-1 w-full bg-red-500" />
             )}

             <CardHeader className="pb-2 pt-4 px-4">
               <div className="flex items-center justify-between">
                 <div className="flex items-center gap-2">
                   <div className={cn(
                     'flex h-8 w-8 items-center justify-center rounded-lg',
                     status === 'pending' && 'bg-slate-100 text-slate-400',
                     status === 'running' && 'bg-blue-100 text-blue-600',
                     status === 'completed' && 'bg-emerald-100 text-emerald-600',
                     status === 'failed' && 'bg-red-100 text-red-600',
                   )}>
                     <Icon className="h-4 w-4" />
                   </div>
                   <div>
                     <h3 className="text-sm font-semibold leading-none">{label}</h3>
                     <p className="text-xs text-muted-foreground mt-0.5">{description}</p>
                   </div>
                 </div>
                 <AgentStatusBadge status={status} />
               </div>
             </CardHeader>

             <CardContent className="px-4 pb-3 pt-0">
               {/* Completed state: show confidence and duration */}
               {status === 'completed' && (
                 <div className="flex items-center gap-4 text-xs text-muted-foreground">
                   {confidence !== null && (
                     <div className="flex items-center gap-1">
                       <span className="font-medium text-emerald-600">
                         {(confidence * 100).toFixed(0)}%
                       </span>
                       <span>confidence</span>
                     </div>
                   )}
                   {durationMs !== null && (
                     <div className="flex items-center gap-1">
                       <span className="font-medium text-slate-600">
                         {durationMs < 1000
                           ? `${durationMs}ms`
                           : `${(durationMs / 1000).toFixed(1)}s`}
                       </span>
                       <span>elapsed</span>
                     </div>
                   )}
                 </div>
               )}

               {/* Running state: show processing indicator */}
               {status === 'running' && (
                 <div className="flex items-center gap-2 text-xs text-blue-600">
                   <div className="flex gap-1">
                     <span className="inline-block h-1.5 w-1.5 rounded-full bg-blue-500 animate-bounce [animation-delay:0ms]" />
                     <span className="inline-block h-1.5 w-1.5 rounded-full bg-blue-500 animate-bounce [animation-delay:150ms]" />
                     <span className="inline-block h-1.5 w-1.5 rounded-full bg-blue-500 animate-bounce [animation-delay:300ms]" />
                   </div>
                   <span>Processing...</span>
                 </div>
               )}

               {/* Failed state: show error */}
               {status === 'failed' && error && (
                 <p className="text-xs text-red-600 truncate" title={error}>
                   {error}
                 </p>
               )}

               {/* Pending state: show waiting message */}
               {status === 'pending' && (
                 <p className="text-xs text-muted-foreground">Waiting to start...</p>
               )}
             </CardContent>
           </Card>
         );
       }
       ```

       IMPORTANT: The `shimmer` animation for the running state progress bar needs a custom keyframe. Add this to `src/app/globals.css`:
       ```css
       @keyframes shimmer {
         0% { transform: translateX(-100%); }
         100% { transform: translateX(400%); }
       }
       ```
       If globals.css already has Tailwind directives, add the keyframe inside an `@layer utilities` block or as a standalone `@keyframes` rule.
  </action>
  <verify>
    - `npx tsc --noEmit` passes for both component files
    - `AgentStatusBadge` renders correct label and colors for all 4 states
    - `AgentStatusCard` renders icon, label, description, status badge, and status-specific content
    - Running state shows animated progress bar and bouncing dots
    - Completed state shows confidence percentage and formatted duration
    - Failed state shows error message
    - Pending state shows "Waiting to start..." text with reduced opacity
  </verify>
  <done>
    Agent status badge and card components built with full status-awareness. Each state (pending, running, completed, failed) has distinct visual treatment. Icons map to agent types. Running state has shimmer animation. Completed state shows confidence and timing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create pipeline stage indicator and full pipeline view layout</name>
  <files>src/components/pipeline/pipeline-stage-indicator.tsx, src/components/pipeline/agent-pipeline-view.tsx</files>
  <action>
    1. Create `src/components/pipeline/pipeline-stage-indicator.tsx` — horizontal progress showing current pipeline stage:

       ```typescript
       'use client';

       import { PipelineStage } from '@/types';
       import { cn } from '@/lib/utils';
       import {
         FileText,
         Users,
         BarChart3,
         FileEdit,
         CheckCircle2,
       } from 'lucide-react';

       interface PipelineStageIndicatorProps {
         currentStage: PipelineStage | null;
         className?: string;
       }

       const STAGES: Array<{
         id: PipelineStage;
         label: string;
         icon: typeof FileText;
       }> = [
         { id: 'document_processing', label: 'Documents', icon: FileText },
         { id: 'parallel_verification', label: 'Verification', icon: Users },
         { id: 'risk_scoring', label: 'Risk Scoring', icon: BarChart3 },
         { id: 'narrative_generation', label: 'Narrative', icon: FileEdit },
         { id: 'completed', label: 'Complete', icon: CheckCircle2 },
       ];

       const STAGE_ORDER: Record<string, number> = {
         initialized: 0,
         document_processing: 1,
         parallel_verification: 2,
         risk_scoring: 3,
         narrative_generation: 4,
         completed: 5,
         failed: -1,
       };

       export function PipelineStageIndicator({
         currentStage,
         className,
       }: PipelineStageIndicatorProps) {
         const currentOrder = currentStage ? (STAGE_ORDER[currentStage] ?? 0) : 0;

         return (
           <div className={cn('flex items-center gap-1', className)}>
             {STAGES.map((stage, index) => {
               const stageOrder = STAGE_ORDER[stage.id] ?? index + 1;
               const isActive = currentStage === stage.id;
               const isCompleted = currentOrder > stageOrder;
               const isPending = currentOrder < stageOrder;

               const Icon = stage.icon;

               return (
                 <div key={stage.id} className="flex items-center">
                   {/* Stage node */}
                   <div className="flex flex-col items-center gap-1">
                     <div
                       className={cn(
                         'flex h-9 w-9 items-center justify-center rounded-full border-2 transition-all duration-500',
                         isActive && 'border-blue-500 bg-blue-50 text-blue-600 ring-4 ring-blue-100',
                         isCompleted && 'border-emerald-500 bg-emerald-50 text-emerald-600',
                         isPending && 'border-slate-200 bg-slate-50 text-slate-400',
                       )}
                     >
                       {isCompleted ? (
                         <CheckCircle2 className="h-4 w-4" />
                       ) : (
                         <Icon className="h-4 w-4" />
                       )}
                     </div>
                     <span
                       className={cn(
                         'text-[10px] font-medium whitespace-nowrap',
                         isActive && 'text-blue-600',
                         isCompleted && 'text-emerald-600',
                         isPending && 'text-slate-400',
                       )}
                     >
                       {stage.label}
                     </span>
                   </div>

                   {/* Connector line between stages (except last) */}
                   {index < STAGES.length - 1 && (
                     <div
                       className={cn(
                         'h-0.5 w-8 mx-1 mt-[-16px] transition-colors duration-500',
                         isCompleted ? 'bg-emerald-400' : 'bg-slate-200',
                       )}
                     />
                   )}
                 </div>
               );
             })}
           </div>
         );
       }
       ```

    2. Create `src/components/pipeline/agent-pipeline-view.tsx` — the full pipeline visualization layout:

       ```typescript
       'use client';

       import { AgentStatusCard } from './agent-status-card';
       import { PipelineStageIndicator } from './pipeline-stage-indicator';
       import { AgentStatusInfo } from '@/lib/hooks/use-agent-status';
       import { PipelineUpdate, StreamStatus } from '@/lib/hooks/use-pipeline-stream';
       import { cn } from '@/lib/utils';

       interface AgentPipelineViewProps {
         agents: AgentStatusInfo[];
         pipelineUpdate: PipelineUpdate | null;
         streamStatus: StreamStatus;
         className?: string;
       }

       export function AgentPipelineView({
         agents,
         pipelineUpdate,
         streamStatus,
         className,
       }: AgentPipelineViewProps) {
         // Group agents by execution order/wave
         const docProcessor = agents.find(a => a.agentType === 'document_processor');
         const identityVerifier = agents.find(a => a.agentType === 'identity_verifier');
         const sanctionsScreener = agents.find(a => a.agentType === 'sanctions_screener');
         const riskScorer = agents.find(a => a.agentType === 'risk_scorer');
         const caseNarrator = agents.find(a => a.agentType === 'case_narrator');

         const currentStage = pipelineUpdate?.stage ?? null;

         return (
           <div className={cn('space-y-6', className)}>
             {/* Pipeline stage progress bar */}
             <div className="flex justify-center">
               <PipelineStageIndicator currentStage={currentStage} />
             </div>

             {/* Stream status indicator */}
             {streamStatus === 'connecting' && (
               <div className="text-center text-sm text-muted-foreground animate-pulse">
                 Connecting to pipeline...
               </div>
             )}

             {/* Agent cards in pipeline layout */}
             <div className="space-y-4">
               {/* Stage 1: Document Processing (single agent, full width) */}
               <div className="flex justify-center">
                 <div className="w-full max-w-md">
                   {docProcessor && (
                     <AgentStatusCard
                       label={docProcessor.label}
                       description={docProcessor.description}
                       agentType={docProcessor.agentType}
                       status={docProcessor.status}
                       confidence={docProcessor.confidence}
                       durationMs={docProcessor.durationMs}
                       error={docProcessor.error}
                     />
                   )}
                 </div>
               </div>

               {/* Connector arrow from doc processor to parallel stage */}
               <div className="flex justify-center">
                 <div className="flex flex-col items-center">
                   <div className={cn(
                     'h-6 w-0.5',
                     (currentStage && ['parallel_verification', 'risk_scoring', 'narrative_generation', 'completed'].includes(currentStage))
                       ? 'bg-emerald-400'
                       : 'bg-slate-200',
                   )} />
                   {/* Fork indicator for parallel */}
                   <div className={cn(
                     'h-0.5 w-48',
                     (currentStage && ['parallel_verification', 'risk_scoring', 'narrative_generation', 'completed'].includes(currentStage))
                       ? 'bg-emerald-400'
                       : 'bg-slate-200',
                   )} />
                 </div>
               </div>

               {/* Stage 2: Parallel Verification (two agents side-by-side) */}
               <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto">
                 {identityVerifier && (
                   <AgentStatusCard
                     label={identityVerifier.label}
                     description={identityVerifier.description}
                     agentType={identityVerifier.agentType}
                     status={identityVerifier.status}
                     confidence={identityVerifier.confidence}
                     durationMs={identityVerifier.durationMs}
                     error={identityVerifier.error}
                   />
                 )}
                 {sanctionsScreener && (
                   <AgentStatusCard
                     label={sanctionsScreener.label}
                     description={sanctionsScreener.description}
                     agentType={sanctionsScreener.agentType}
                     status={sanctionsScreener.status}
                     confidence={sanctionsScreener.confidence}
                     durationMs={sanctionsScreener.durationMs}
                     error={sanctionsScreener.error}
                   />
                 )}
               </div>

               {/* Connector arrow from parallel stage to risk scoring */}
               <div className="flex justify-center">
                 <div className="flex flex-col items-center">
                   <div className={cn(
                     'h-0.5 w-48',
                     (currentStage && ['risk_scoring', 'narrative_generation', 'completed'].includes(currentStage))
                       ? 'bg-emerald-400'
                       : 'bg-slate-200',
                   )} />
                   <div className={cn(
                     'h-6 w-0.5',
                     (currentStage && ['risk_scoring', 'narrative_generation', 'completed'].includes(currentStage))
                       ? 'bg-emerald-400'
                       : 'bg-slate-200',
                   )} />
                 </div>
               </div>

               {/* Stage 3: Risk Scoring (single agent) */}
               <div className="flex justify-center">
                 <div className="w-full max-w-md">
                   {riskScorer && (
                     <AgentStatusCard
                       label={riskScorer.label}
                       description={riskScorer.description}
                       agentType={riskScorer.agentType}
                       status={riskScorer.status}
                       confidence={riskScorer.confidence}
                       durationMs={riskScorer.durationMs}
                       error={riskScorer.error}
                     />
                   )}
                 </div>
               </div>

               {/* Connector arrow from risk scoring to narrative */}
               <div className="flex justify-center">
                 <div className={cn(
                   'h-6 w-0.5',
                   (currentStage && ['narrative_generation', 'completed'].includes(currentStage))
                     ? 'bg-emerald-400'
                     : 'bg-slate-200',
                 )} />
               </div>

               {/* Stage 4: Case Narrative (single agent) */}
               <div className="flex justify-center">
                 <div className="w-full max-w-md">
                   {caseNarrator && (
                     <AgentStatusCard
                       label={caseNarrator.label}
                       description={caseNarrator.description}
                       agentType={caseNarrator.agentType}
                       status={caseNarrator.status}
                       confidence={caseNarrator.confidence}
                       durationMs={caseNarrator.durationMs}
                       error={caseNarrator.error}
                     />
                   )}
                 </div>
               </div>
             </div>

             {/* Error summary */}
             {pipelineUpdate && pipelineUpdate.errors.length > 0 && (
               <div className="rounded-lg border border-red-200 bg-red-50 p-4 max-w-2xl mx-auto">
                 <h4 className="text-sm font-semibold text-red-800 mb-2">Pipeline Errors</h4>
                 <ul className="space-y-1">
                   {pipelineUpdate.errors.map((err, i) => (
                     <li key={i} className="text-xs text-red-700">
                       [{err.stage}] {err.agent_type}: {err.error_message}
                     </li>
                   ))}
                 </ul>
               </div>
             )}
           </div>
         );
       }
       ```

       IMPORTANT LAYOUT DECISIONS:
       - Document Processor is full-width, centered (single agent, first stage)
       - Identity Verifier and Sanctions Screener are side-by-side in a 2-column grid — this is critical for visualizing parallel execution
       - Risk Scorer is full-width, centered (single agent, depends on both parallel agents)
       - Case Narrator is full-width, centered (final stage)
       - Connector lines between stages change color from slate to emerald as the pipeline progresses
       - The fork/join pattern with horizontal lines at the parallel stage makes the parallelism visually obvious

       The component takes pre-computed agent data — it does NOT subscribe to the stream itself. The parent page component calls `usePipelineStream()` and `useAgentStatus()`, then passes data down. This keeps the pipeline view a pure presentational component.
  </action>
  <verify>
    - `npx tsc --noEmit` passes for both component files
    - `AgentPipelineView` renders all 5 agent cards in correct layout: 1 -> 2 parallel -> 1 -> 1
    - `PipelineStageIndicator` shows 5 stages with correct active/completed/pending states
    - Connector lines change color based on pipeline progress
    - Parallel agents (identity + sanctions) render in a 2-column grid on md+ screens
    - Error summary renders when pipeline has errors
    - All components have `'use client'` directive
  </verify>
  <done>
    Full pipeline visualization layout built. Document Processor -> [Identity Verifier | Sanctions Screener] (parallel, side-by-side) -> Risk Scorer -> Case Narrator. Stage progress indicator shows pipeline position. Connector lines track progress. Errors displayed in summary panel.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for all 4 component files
2. AgentStatusBadge renders correct colors/labels for all 4 states (pending, running, completed, failed)
3. AgentStatusCard shows icon, label, description, badge, and state-specific content (dots for running, confidence for completed, error for failed)
4. PipelineStageIndicator progresses through 5 stages with correct visual state
5. AgentPipelineView renders the fork/join parallel layout with 2-column grid for verification agents
6. Connector lines transition from slate-200 to emerald-400 as pipeline progresses
7. All components are composable — pipeline view receives data as props, does not manage SSE connection
</verification>

<success_criteria>
- Each agent's processing status visible as a distinct card with real-time updates (DASH-02)
- Parallel agent execution visually represented by side-by-side layout with simultaneous running animations
- Pipeline progress indicator shows current stage position
- Component architecture is clean: presentational components receive data, parent manages stream
</success_criteria>

<output>
After completion, create `.planning/phases/07-agent-visualization/07-02-SUMMARY.md`
</output>
