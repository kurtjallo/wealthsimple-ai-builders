---
phase: 02-agent-orchestration-core
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/lib/agents/stubs/document-processor.stub.ts
  - src/lib/agents/stubs/identity-verifier.stub.ts
  - src/lib/agents/stubs/sanctions-screener.stub.ts
  - src/lib/agents/stubs/risk-scorer.stub.ts
  - src/lib/agents/stubs/case-narrator.stub.ts
  - src/lib/agents/stubs/index.ts
autonomous: true

must_haves:
  truths:
    - "Each stub agent returns realistic typed data matching its output contract"
    - "Stub agents simulate realistic timing (200-1500ms delays)"
    - "All 5 stub agents register with the orchestrator and can be invoked"
  artifacts:
    - path: "src/lib/agents/stubs/document-processor.stub.ts"
      provides: "Stub DocumentProcessor that returns realistic extracted fields"
      contains: "documentProcessorStub"
    - path: "src/lib/agents/stubs/identity-verifier.stub.ts"
      provides: "Stub IdentityVerifier that returns match results"
      contains: "identityVerifierStub"
    - path: "src/lib/agents/stubs/sanctions-screener.stub.ts"
      provides: "Stub SanctionsScreener that returns screening results"
      contains: "sanctionsScreenerStub"
    - path: "src/lib/agents/stubs/risk-scorer.stub.ts"
      provides: "Stub RiskScorer that returns weighted risk scores"
      contains: "riskScorerStub"
    - path: "src/lib/agents/stubs/case-narrator.stub.ts"
      provides: "Stub CaseNarrator that returns narrative text"
      contains: "caseNarratorStub"
    - path: "src/lib/agents/stubs/index.ts"
      provides: "Registers all stub agents with the orchestrator"
      contains: "registerAllStubs"
  key_links:
    - from: "src/lib/agents/stubs/index.ts"
      to: "src/lib/agents/orchestrator.ts"
      via: "calls registerAgent for each stub"
      pattern: "registerAgent"
    - from: "src/lib/agents/stubs/document-processor.stub.ts"
      to: "src/types/agents.ts"
      via: "returns DocumentProcessorOutput"
      pattern: "DocumentProcessorOutput"
---

<objective>
Create realistic stub implementations for all 5 specialized agents. These stubs return properly typed, realistic-looking data with simulated delays, enabling the full pipeline to run end-to-end without requiring Claude API calls.

Purpose: Stubs let us test the orchestration pipeline immediately. They serve as the contract reference for when real agents are implemented in later phases. They also provide demo-ready fallback data.
Output: 5 stub agents registered with the orchestrator, each returning realistic typed output.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-agent-orchestration-core/02-01-SUMMARY.md
@.planning/phases/02-agent-orchestration-core/02-02-SUMMARY.md
@src/types/agents.ts
@src/types/pipeline.ts
@src/lib/agents/orchestrator.ts
@src/lib/agents/base-agent.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DocumentProcessor, IdentityVerifier, and SanctionsScreener stubs</name>
  <files>
    src/lib/agents/stubs/document-processor.stub.ts,
    src/lib/agents/stubs/identity-verifier.stub.ts,
    src/lib/agents/stubs/sanctions-screener.stub.ts
  </files>
  <action>
    Create three stub agent files. Each stub:
    - Is a function matching the handler signature: `(input: TInput, client: Anthropic, config: AgentConfig) => Promise<TOutput>`
    - Simulates realistic timing with `await new Promise(r => setTimeout(r, delay))`
    - Returns typed data that looks like what a real agent would produce
    - Does NOT call the Claude API (that's for later phases)

    1. **`src/lib/agents/stubs/document-processor.stub.ts`:**

       Returns realistic extracted fields for a passport-like document. Simulate 800-1200ms delay.

       ```typescript
       import Anthropic from '@anthropic-ai/sdk';
       import { AgentConfig, DocumentProcessorInput, DocumentProcessorOutput } from '@/types';

       export async function documentProcessorStub(
         input: DocumentProcessorInput,
         _client: Anthropic,
         _config: AgentConfig,
       ): Promise<DocumentProcessorOutput> {
         // Simulate OCR processing time
         await new Promise(r => setTimeout(r, 800 + Math.random() * 400));

         const docId = input.documents[0]?.id || 'doc-001';

         return {
           extracted_fields: [
             { field_name: 'full_name', value: 'John Michael Smith', confidence: 0.95, source_document_id: docId },
             { field_name: 'date_of_birth', value: '1985-03-15', confidence: 0.92, source_document_id: docId },
             { field_name: 'document_number', value: 'P12345678', confidence: 0.98, source_document_id: docId },
             { field_name: 'nationality', value: 'Canadian', confidence: 0.97, source_document_id: docId },
             { field_name: 'expiry_date', value: '2028-03-14', confidence: 0.94, source_document_id: docId },
             { field_name: 'address', value: '123 Bay Street, Toronto, ON M5J 2T3', confidence: 0.88, source_document_id: docId },
           ],
           raw_ocr_text: {
             [docId]: 'CANADA / PASSPORT\\nSurname: SMITH\\nGiven Names: JOHN MICHAEL\\nDate of Birth: 15 MAR 1985\\nPassport No: P12345678\\nNationality: CANADIAN\\nDate of Expiry: 14 MAR 2028',
           },
           document_quality: {
             [docId]: 0.91,
           },
         };
       }
       ```

    2. **`src/lib/agents/stubs/identity-verifier.stub.ts`:**

       Returns identity match results. Simulate 400-800ms delay.

       ```typescript
       import Anthropic from '@anthropic-ai/sdk';
       import { AgentConfig, IdentityVerifierInput, IdentityVerifierOutput } from '@/types';

       export async function identityVerifierStub(
         input: IdentityVerifierInput,
         _client: Anthropic,
         _config: AgentConfig,
       ): Promise<IdentityVerifierOutput> {
         await new Promise(r => setTimeout(r, 400 + Math.random() * 400));

         const nameFromDocs = input.extracted_fields.find(f => f.field_name === 'full_name')?.value || 'Unknown';

         return {
           verified: true,
           matches: [
             { field_name: 'full_name', expected: input.applicant_name, actual: nameFromDocs, match: true, confidence: 0.94 },
             { field_name: 'date_of_birth', expected: '1985-03-15', actual: '1985-03-15', match: true, confidence: 0.98 },
             { field_name: 'nationality', expected: 'Canadian', actual: 'Canadian', match: true, confidence: 0.96 },
           ],
           discrepancies: [],
           verification_summary: `Identity verified for ${input.applicant_name}. All document fields match application data with high confidence. No discrepancies found.`,
         };
       }
       ```

    3. **`src/lib/agents/stubs/sanctions-screener.stub.ts`:**

       Returns clean screening results (no matches). Simulate 500-900ms delay.

       ```typescript
       import Anthropic from '@anthropic-ai/sdk';
       import { AgentConfig, SanctionsScreenerInput, SanctionsScreenerOutput } from '@/types';

       export async function sanctionsScreenerStub(
         input: SanctionsScreenerInput,
         _client: Anthropic,
         _config: AgentConfig,
       ): Promise<SanctionsScreenerOutput> {
         await new Promise(r => setTimeout(r, 500 + Math.random() * 400));

         return {
           flagged: false,
           matches: [],
           lists_checked: ['UN Security Council Consolidated List', 'OFAC SDN List', 'PEP Database'],
           screening_summary: `No sanctions matches found for ${input.applicant_name}. Screened against UN Security Council Consolidated List, OFAC SDN List, and PEP database. All clear.`,
         };
       }
       ```

    IMPORTANT: All stubs use the exact same function signature that `runAgent` expects: `(input, client, config) => Promise<Output>`. The `_client` and `_config` params are unused but required for type compatibility.
  </action>
  <verify>
    - `npx tsc --noEmit` passes — all stubs type-check against their contracts
    - Each stub returns data matching its Output interface exactly
    - Each stub has a simulated delay (no instant returns)
  </verify>
  <done>
    First 3 stub agents created: DocumentProcessor, IdentityVerifier, SanctionsScreener. All return realistic typed data with simulated processing delays.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RiskScorer, CaseNarrator stubs and registration index</name>
  <files>
    src/lib/agents/stubs/risk-scorer.stub.ts,
    src/lib/agents/stubs/case-narrator.stub.ts,
    src/lib/agents/stubs/index.ts
  </files>
  <action>
    1. **`src/lib/agents/stubs/risk-scorer.stub.ts`:**

       Aggregates upstream results into a risk score. Simulate 600-1000ms delay.

       ```typescript
       import Anthropic from '@anthropic-ai/sdk';
       import { AgentConfig, RiskScorerInput, RiskScorerOutput, RiskLevel } from '@/types';

       export async function riskScorerStub(
         input: RiskScorerInput,
         _client: Anthropic,
         _config: AgentConfig,
       ): Promise<RiskScorerOutput> {
         await new Promise(r => setTimeout(r, 600 + Math.random() * 400));

         // Calculate risk based on upstream results
         const docConfidence = input.document_result.confidence;
         const identityVerified = input.identity_result.data?.verified ?? false;
         const sanctionsFlagged = input.sanctions_result.data?.flagged ?? false;

         let riskScore = 15; // Base low risk
         const factors: RiskScorerOutput['risk_factors'] = [];

         // Document quality factor
         factors.push({
           factor_name: 'document_quality',
           weight: 0.25,
           score: docConfidence * 100,
           explanation: `Document processing confidence: ${(docConfidence * 100).toFixed(0)}%`,
         });

         // Identity verification factor
         if (!identityVerified) {
           riskScore += 30;
         }
         factors.push({
           factor_name: 'identity_verification',
           weight: 0.3,
           score: identityVerified ? 10 : 70,
           explanation: identityVerified
             ? 'Identity verified — all fields match'
             : 'Identity NOT verified — discrepancies found',
         });

         // Sanctions screening factor
         if (sanctionsFlagged) {
           riskScore += 50;
         }
         factors.push({
           factor_name: 'sanctions_screening',
           weight: 0.35,
           score: sanctionsFlagged ? 95 : 5,
           explanation: sanctionsFlagged
             ? 'SANCTIONS MATCH FOUND — requires immediate review'
             : 'No sanctions matches — clear on all lists',
         });

         // Agent reliability factor
         const agentFailures = [input.identity_result, input.sanctions_result]
           .filter(r => !r.success).length;
         factors.push({
           factor_name: 'agent_reliability',
           weight: 0.1,
           score: agentFailures > 0 ? 60 : 5,
           explanation: agentFailures > 0
             ? `${agentFailures} verification agent(s) failed — degraded confidence`
             : 'All agents completed successfully',
         });

         const riskLevel: RiskLevel = riskScore <= 25 ? 'low'
           : riskScore <= 50 ? 'medium'
           : riskScore <= 75 ? 'high'
           : 'critical';

         return {
           risk_score: Math.min(100, riskScore),
           risk_level: riskLevel,
           risk_factors: factors,
           requires_manual_review: riskLevel === 'high' || riskLevel === 'critical' || agentFailures > 0,
           scoring_summary: `Risk assessment: ${riskLevel.toUpperCase()} (${riskScore}/100). ${factors.length} factors evaluated.`,
         };
       }
       ```

    2. **`src/lib/agents/stubs/case-narrator.stub.ts`:**

       Generates a case narrative from all results. Simulate 1000-1500ms delay (narrator does the most "writing").

       ```typescript
       import Anthropic from '@anthropic-ai/sdk';
       import { AgentConfig, CaseNarratorInput, CaseNarratorOutput } from '@/types';

       export async function caseNarratorStub(
         input: CaseNarratorInput,
         _client: Anthropic,
         _config: AgentConfig,
       ): Promise<CaseNarratorOutput> {
         await new Promise(r => setTimeout(r, 1000 + Math.random() * 500));

         const riskLevel = input.risk_result.data?.risk_level || 'unknown';
         const riskScore = input.risk_result.data?.risk_score || 0;
         const sanctionsFlagged = input.sanctions_result.data?.flagged || false;
         const identityVerified = input.identity_result.data?.verified || false;

         const narrative = [
           `## KYC/AML Assessment: ${input.applicant_name}`,
           '',
           `**Risk Level:** ${riskLevel.toUpperCase()} (Score: ${riskScore}/100)`,
           '',
           '### Document Verification',
           `Documents were processed and ${input.document_result.data?.extracted_fields.length || 0} data fields were extracted. ` +
           `Overall document quality rated at ${((input.document_result.data?.document_quality[Object.keys(input.document_result.data?.document_quality || {})[0] || ''] || 0) * 100).toFixed(0)}%.`,
           '',
           '### Identity Verification',
           identityVerified
             ? 'All identity fields match between the application and submitted documents. No discrepancies detected.'
             : 'Identity verification flagged discrepancies between application data and document fields. Manual review recommended.',
           '',
           '### Sanctions Screening',
           sanctionsFlagged
             ? 'WARNING: Potential sanctions list match detected. Immediate manual review required before proceeding.'
             : 'No matches found against UN Security Council Consolidated List, OFAC SDN List, or PEP databases.',
           '',
           '### Recommendation',
           riskLevel === 'low' ? 'Recommend APPROVAL — low risk profile with clean verification across all checks.'
             : riskLevel === 'medium' ? 'Recommend REVIEW — moderate risk indicators present. Officer review advised before decision.'
             : 'Recommend ESCALATION — elevated risk profile requires senior compliance officer review.',
         ].join('\n');

         return {
           narrative,
           key_findings: [
             `Risk score: ${riskScore}/100 (${riskLevel})`,
             identityVerified ? 'Identity verified — all fields match' : 'Identity verification — discrepancies found',
             sanctionsFlagged ? 'Sanctions match detected' : 'Sanctions screening — clear',
             `${input.document_result.data?.extracted_fields.length || 0} document fields extracted`,
           ],
           recommended_action: riskLevel === 'low' ? 'approve' : riskLevel === 'medium' ? 'escalate' : 'deny',
           evidence_links: [
             { claim: 'Document extraction completed', source: 'DocumentProcessor agent', confidence: input.document_result.confidence },
             { claim: `Identity ${identityVerified ? 'verified' : 'unverified'}`, source: 'IdentityVerifier agent', confidence: input.identity_result.confidence },
             { claim: `Sanctions ${sanctionsFlagged ? 'flagged' : 'clear'}`, source: 'SanctionsScreener agent', confidence: input.sanctions_result.confidence },
             { claim: `Risk: ${riskLevel}`, source: 'RiskScorer agent', confidence: input.risk_result.confidence },
           ],
         };
       }
       ```

    3. **`src/lib/agents/stubs/index.ts`:**

       Registration module that plugs all stubs into the orchestrator.

       ```typescript
       import { registerAgent } from '../orchestrator';
       import { documentProcessorStub } from './document-processor.stub';
       import { identityVerifierStub } from './identity-verifier.stub';
       import { sanctionsScreenerStub } from './sanctions-screener.stub';
       import { riskScorerStub } from './risk-scorer.stub';
       import { caseNarratorStub } from './case-narrator.stub';

       export function registerAllStubs(): void {
         registerAgent('document_processor', documentProcessorStub);
         registerAgent('identity_verifier', identityVerifierStub);
         registerAgent('sanctions_screener', sanctionsScreenerStub);
         registerAgent('risk_scorer', riskScorerStub);
         registerAgent('case_narrator', caseNarratorStub);
       }

       // Re-export individual stubs for testing
       export { documentProcessorStub } from './document-processor.stub';
       export { identityVerifierStub } from './identity-verifier.stub';
       export { sanctionsScreenerStub } from './sanctions-screener.stub';
       export { riskScorerStub } from './risk-scorer.stub';
       export { caseNarratorStub } from './case-narrator.stub';
       ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes — all stubs compile correctly
    - `registerAllStubs()` registers all 5 agents without errors
    - RiskScorer stub produces different outputs based on upstream agent results (not hardcoded)
    - CaseNarrator stub generates a full markdown narrative
    - All stubs have simulated delays
  </verify>
  <done>
    All 5 stub agents created and registered. RiskScorer dynamically calculates scores from upstream results. CaseNarrator generates markdown narratives. registerAllStubs() wires everything into the orchestrator.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes — all stubs type-check against contracts
2. Importing `registerAllStubs` and calling it registers all 5 handlers
3. Each stub has realistic delays (200-1500ms range)
4. RiskScorer output varies based on identity/sanctions results
5. CaseNarrator produces a multi-section markdown narrative
6. All outputs match their respective TypeScript interface contracts exactly
</verification>

<success_criteria>
- All 5 stub agents return realistic, properly typed data
- Stubs simulate realistic processing delays for demo/testing purposes
- registerAllStubs() plugs all agents into the orchestrator registry
- Pipeline can run end-to-end with stubs (tested in Plan 05)
</success_criteria>

<output>
After completion, create `.planning/phases/02-agent-orchestration-core/02-03-SUMMARY.md`
</output>
