---
phase: 06-dashboard-core
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/app/api/cases/[id]/route.ts
  - src/app/api/cases/[id]/agent-runs/route.ts
  - src/app/dashboard/cases/[id]/page.tsx
  - src/components/cases/risk-profile-card.tsx
  - src/components/cases/agent-results-panel.tsx
  - src/components/cases/evidence-section.tsx
  - src/components/cases/case-narrative-card.tsx
autonomous: true

must_haves:
  truths:
    - "GET /api/cases/[id] returns a single case with all fields from Supabase"
    - "GET /api/cases/[id]/agent-runs returns all agent runs for a case ordered by created_at"
    - "Case detail page shows the case header with applicant info, status, and risk level"
    - "Risk profile card displays composite risk score, risk level, and risk factors breakdown"
    - "Agent results panel shows each agent's output with expandable detail sections"
    - "Case narrative card shows the AI-generated assessment narrative with key findings"
    - "Evidence section links claims to specific agent results with confidence scores"
  artifacts:
    - path: "src/app/api/cases/[id]/route.ts"
      provides: "GET endpoint for a single case by ID"
      exports: ["GET"]
    - path: "src/app/api/cases/[id]/agent-runs/route.ts"
      provides: "GET endpoint for agent runs associated with a case"
      exports: ["GET"]
    - path: "src/app/dashboard/cases/[id]/page.tsx"
      provides: "Case detail page with risk profile, agent results, and narrative"
      contains: "CaseDetailPage"
    - path: "src/components/cases/risk-profile-card.tsx"
      provides: "Risk score display with gauge, level, and factors breakdown"
      exports: ["RiskProfileCard"]
    - path: "src/components/cases/agent-results-panel.tsx"
      provides: "Expandable panel showing each agent's processing results"
      exports: ["AgentResultsPanel"]
    - path: "src/components/cases/evidence-section.tsx"
      provides: "Evidence links connecting narrative claims to agent data"
      exports: ["EvidenceSection"]
    - path: "src/components/cases/case-narrative-card.tsx"
      provides: "AI-generated case narrative display with key findings"
      exports: ["CaseNarrativeCard"]
  key_links:
    - from: "src/app/dashboard/cases/[id]/page.tsx"
      to: "/api/cases/[id]"
      via: "fetches case data from API"
      pattern: "fetch.*api/cases/"
    - from: "src/app/dashboard/cases/[id]/page.tsx"
      to: "/api/cases/[id]/agent-runs"
      via: "fetches agent run data from API"
      pattern: "fetch.*agent-runs"
    - from: "src/app/dashboard/cases/[id]/page.tsx"
      to: "src/components/cases/risk-profile-card.tsx"
      via: "renders RiskProfileCard with risk scorer output"
      pattern: "import.*RiskProfileCard"
    - from: "src/app/dashboard/cases/[id]/page.tsx"
      to: "src/components/cases/case-narrative-card.tsx"
      via: "renders CaseNarrativeCard with narrator output"
      pattern: "import.*CaseNarrativeCard"
    - from: "src/components/cases/risk-profile-card.tsx"
      to: "src/lib/constants.ts"
      via: "uses RISK_LEVEL_CONFIG for risk display"
      pattern: "import.*RISK_LEVEL_CONFIG"
---

<objective>
Build the case detail / risk profile view page (DASH-03) — the comprehensive view where a compliance officer reviews all evidence, risk scores, agent results, and the AI-generated narrative before making a decision.

Purpose: This is where the compliance officer spends their time. The page synthesizes outputs from all agents into a readable assessment: risk score at top, narrative in the middle, and agent detail drill-downs below. Every claim links back to evidence. This is the critical page that enables the 5-days-to-3-minutes workflow.

Output: API routes for single case and agent runs, case detail page with risk profile card, narrative card, agent results panel, and evidence drill-down.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-dashboard-core/06-01-SUMMARY.md
@src/types/index.ts (Case, CaseStatus, RiskLevel, AgentRun, AgentType)
@src/types/agents.ts (RiskScorerOutput, CaseNarratorOutput, RiskFactor, DocumentProcessorOutput, IdentityVerifierOutput, SanctionsScreenerOutput)
@src/lib/supabase/server.ts (createServerSupabaseClient)
@src/lib/constants.ts (STATUS_CONFIG, RISK_LEVEL_CONFIG)
@src/components/layout/dashboard-shell.tsx (DashboardShell)
@src/components/cases/case-status-badge.tsx (CaseStatusBadge)
@src/components/cases/case-risk-badge.tsx (CaseRiskBadge)
@src/components/ui/card.tsx (Card, CardContent, CardHeader, CardTitle, CardDescription)
@src/components/ui/tabs.tsx (Tabs, TabsContent, TabsList, TabsTrigger)
@src/components/ui/separator.tsx (Separator)
@src/components/ui/badge.tsx (Badge)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create case detail and agent runs API routes</name>
  <files>src/app/api/cases/[id]/route.ts, src/app/api/cases/[id]/agent-runs/route.ts</files>
  <action>
    **Create `src/app/api/cases/[id]/route.ts`:**

    GET endpoint returning a single case by ID.

    ```typescript
    import { NextRequest, NextResponse } from 'next/server';
    import { createServerSupabaseClient } from '@/lib/supabase/server';

    export async function GET(
      request: NextRequest,
      { params }: { params: Promise<{ id: string }> }
    ) {
      try {
        const { id } = await params;
        const supabase = createServerSupabaseClient();

        const { data: caseData, error } = await supabase
          .from('cases')
          .select('*')
          .eq('id', id)
          .single();

        if (error || !caseData) {
          return NextResponse.json(
            { error: 'Case not found' },
            { status: 404 }
          );
        }

        return NextResponse.json(caseData);
      } catch (error) {
        return NextResponse.json(
          { error: error instanceof Error ? error.message : 'Internal error' },
          { status: 500 }
        );
      }
    }
    ```

    IMPORTANT: Next.js 15 dynamic route params is a Promise — must use `await params`.

    NOTE: This file may already have a POST handler from Phase 5 (05-03-PLAN.md created risk/narrative endpoints under [id]/risk and [id]/narrative). The GET handler here is at /api/cases/[id]/ — a different route from /api/cases/[id]/risk/. If the file already exists with other handlers, read it first and add GET alongside them. If it doesn't exist, create it fresh with just GET.

    **Create `src/app/api/cases/[id]/agent-runs/route.ts`:**

    GET endpoint returning all agent runs for a specific case, ordered by creation time.

    ```typescript
    import { NextRequest, NextResponse } from 'next/server';
    import { createServerSupabaseClient } from '@/lib/supabase/server';

    export async function GET(
      request: NextRequest,
      { params }: { params: Promise<{ id: string }> }
    ) {
      try {
        const { id: caseId } = await params;
        const supabase = createServerSupabaseClient();

        // Verify case exists
        const { data: caseData, error: caseError } = await supabase
          .from('cases')
          .select('id')
          .eq('id', caseId)
          .single();

        if (caseError || !caseData) {
          return NextResponse.json(
            { error: 'Case not found' },
            { status: 404 }
          );
        }

        // Fetch all agent runs for this case
        const { data: agentRuns, error } = await supabase
          .from('agent_runs')
          .select('*')
          .eq('case_id', caseId)
          .order('created_at', { ascending: true });

        if (error) {
          return NextResponse.json(
            { error: 'Failed to fetch agent runs' },
            { status: 500 }
          );
        }

        return NextResponse.json({
          agent_runs: agentRuns || [],
          case_id: caseId,
        });
      } catch (error) {
        return NextResponse.json(
          { error: error instanceof Error ? error.message : 'Internal error' },
          { status: 500 }
        );
      }
    }
    ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - GET /api/cases/[id] returns case data or 404
    - GET /api/cases/[id]/agent-runs returns { agent_runs: [], case_id } or 404
    - Both endpoints use `await params` for Next.js 15 compatibility
    - Both endpoints handle missing case with 404
    - Both endpoints handle Supabase errors with 500
  </verify>
  <done>API routes for single case and agent runs created. Both handle errors gracefully with appropriate status codes. Ready for case detail page consumption.</done>
</task>

<task type="auto">
  <name>Task 2: Create risk profile, narrative, agent results, and evidence components</name>
  <files>src/components/cases/risk-profile-card.tsx, src/components/cases/case-narrative-card.tsx, src/components/cases/agent-results-panel.tsx, src/components/cases/evidence-section.tsx</files>
  <action>
    **Create `src/components/cases/risk-profile-card.tsx`:**

    Displays the composite risk score prominently with risk level indicator and risk factors breakdown.

    ```typescript
    import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
    import { Badge } from '@/components/ui/badge';
    import { Separator } from '@/components/ui/separator';
    import { RISK_LEVEL_CONFIG } from '@/lib/constants';
    import { RiskLevel } from '@/types';
    import { cn } from '@/lib/utils';
    import { ShieldAlert, ShieldCheck, AlertTriangle } from 'lucide-react';

    interface RiskFactor {
      factor_name: string;
      weight: number;
      score: number;
      explanation: string;
    }

    interface RiskProfileCardProps {
      riskScore: number | null;
      riskLevel: RiskLevel | null;
      riskFactors: RiskFactor[];
      requiresManualReview: boolean;
      scoringSummary?: string;
    }

    export function RiskProfileCard({
      riskScore,
      riskLevel,
      riskFactors,
      requiresManualReview,
      scoringSummary,
    }: RiskProfileCardProps) {
      if (riskScore === null || riskLevel === null) {
        return (
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2 text-base">
                <ShieldAlert className="h-4 w-4" />
                Risk Profile
              </CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-sm text-muted-foreground">
                Risk scoring has not been completed for this case.
              </p>
            </CardContent>
          </Card>
        );
      }

      const config = RISK_LEVEL_CONFIG[riskLevel];
      const RiskIcon = riskLevel === 'low' ? ShieldCheck : ShieldAlert;

      return (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2 text-base">
              <RiskIcon className="h-4 w-4" />
              Risk Profile
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            {/* Risk Score Display */}
            <div className="flex items-center gap-4">
              <div className="flex flex-col items-center">
                <div className={cn(
                  'flex h-16 w-16 items-center justify-center rounded-full border-4',
                  riskLevel === 'low' && 'border-emerald-500 text-emerald-700',
                  riskLevel === 'medium' && 'border-amber-500 text-amber-700',
                  riskLevel === 'high' && 'border-orange-500 text-orange-700',
                  riskLevel === 'critical' && 'border-red-500 text-red-700',
                )}>
                  <span className="text-xl font-bold">{riskScore}</span>
                </div>
                <span className="mt-1 text-xs text-muted-foreground">/ 100</span>
              </div>
              <div className="flex-1">
                <Badge
                  variant="outline"
                  className={cn(config.className, 'mb-2 gap-1.5')}
                >
                  <div className={cn('h-2 w-2 rounded-full', config.dotColor)} />
                  {config.label}
                </Badge>
                {requiresManualReview && (
                  <div className="flex items-center gap-1.5 text-sm text-amber-600">
                    <AlertTriangle className="h-3.5 w-3.5" />
                    Manual review required
                  </div>
                )}
              </div>
            </div>

            {/* Scoring Summary */}
            {scoringSummary && (
              <>
                <Separator />
                <p className="text-sm text-muted-foreground leading-relaxed">
                  {scoringSummary}
                </p>
              </>
            )}

            {/* Risk Factors Breakdown */}
            {riskFactors.length > 0 && (
              <>
                <Separator />
                <div>
                  <h4 className="text-sm font-medium mb-3">Risk Factors</h4>
                  <div className="space-y-3">
                    {riskFactors.map((factor, idx) => (
                      <div key={idx} className="flex items-start gap-3">
                        <div className="flex-1">
                          <div className="flex items-center justify-between mb-1">
                            <span className="text-sm font-medium">
                              {formatFactorName(factor.factor_name)}
                            </span>
                            <span className="text-sm text-muted-foreground">
                              {factor.score}/100
                              <span className="ml-1 text-xs">
                                (weight: {Math.round(factor.weight * 100)}%)
                              </span>
                            </span>
                          </div>
                          {/* Score bar */}
                          <div className="h-2 w-full rounded-full bg-muted">
                            <div
                              className={cn(
                                'h-2 rounded-full transition-all',
                                factor.score <= 25 && 'bg-emerald-500',
                                factor.score > 25 && factor.score <= 50 && 'bg-amber-500',
                                factor.score > 50 && factor.score <= 75 && 'bg-orange-500',
                                factor.score > 75 && 'bg-red-500',
                              )}
                              style={{ width: `${Math.min(factor.score, 100)}%` }}
                            />
                          </div>
                          <p className="mt-1 text-xs text-muted-foreground">
                            {factor.explanation}
                          </p>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </>
            )}
          </CardContent>
        </Card>
      );
    }

    function formatFactorName(name: string): string {
      return name
        .replace(/_/g, ' ')
        .replace(/\b\w/g, (c) => c.toUpperCase());
    }
    ```

    **Create `src/components/cases/case-narrative-card.tsx`:**

    Displays the AI-generated case narrative with key findings and recommended action.

    ```typescript
    import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
    import { Badge } from '@/components/ui/badge';
    import { Separator } from '@/components/ui/separator';
    import { FileText, CheckCircle2, XCircle, AlertTriangle } from 'lucide-react';
    import { cn } from '@/lib/utils';

    interface CaseNarrativeCardProps {
      narrative: string | null;
      keyFindings: string[];
      recommendedAction: string | null;
    }

    export function CaseNarrativeCard({
      narrative,
      keyFindings,
      recommendedAction,
    }: CaseNarrativeCardProps) {
      if (!narrative) {
        return (
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2 text-base">
                <FileText className="h-4 w-4" />
                Case Narrative
              </CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-sm text-muted-foreground">
                Case narrative has not been generated yet.
              </p>
            </CardContent>
          </Card>
        );
      }

      const ActionIcon = recommendedAction === 'approve'
        ? CheckCircle2
        : recommendedAction === 'deny'
          ? XCircle
          : AlertTriangle;

      const actionColor = recommendedAction === 'approve'
        ? 'text-emerald-600'
        : recommendedAction === 'deny'
          ? 'text-red-600'
          : 'text-purple-600';

      return (
        <Card>
          <CardHeader>
            <div className="flex items-center justify-between">
              <CardTitle className="flex items-center gap-2 text-base">
                <FileText className="h-4 w-4" />
                Case Narrative
              </CardTitle>
              {recommendedAction && (
                <Badge
                  variant="outline"
                  className={cn(
                    'gap-1.5',
                    recommendedAction === 'approve' && 'bg-emerald-50 text-emerald-700 border-emerald-200',
                    recommendedAction === 'deny' && 'bg-red-50 text-red-700 border-red-200',
                    recommendedAction === 'escalate' && 'bg-purple-50 text-purple-700 border-purple-200',
                  )}
                >
                  <ActionIcon className="h-3 w-3" />
                  AI Recommends: {recommendedAction.charAt(0).toUpperCase() + recommendedAction.slice(1)}
                </Badge>
              )}
            </div>
          </CardHeader>
          <CardContent className="space-y-4">
            {/* Narrative Text */}
            <div className="prose prose-sm max-w-none text-sm leading-relaxed text-foreground">
              {narrative.split('\n\n').map((paragraph, idx) => (
                <p key={idx}>{paragraph}</p>
              ))}
            </div>

            {/* Key Findings */}
            {keyFindings.length > 0 && (
              <>
                <Separator />
                <div>
                  <h4 className="text-sm font-medium mb-2">Key Findings</h4>
                  <ul className="space-y-1.5">
                    {keyFindings.map((finding, idx) => (
                      <li key={idx} className="flex items-start gap-2 text-sm">
                        <span className="mt-1.5 h-1.5 w-1.5 flex-shrink-0 rounded-full bg-primary" />
                        {finding}
                      </li>
                    ))}
                  </ul>
                </div>
              </>
            )}
          </CardContent>
        </Card>
      );
    }
    ```

    **Create `src/components/cases/agent-results-panel.tsx`:**

    Expandable panel showing each agent's processing results with status, confidence, and output details.

    ```typescript
    'use client';

    import { useState } from 'react';
    import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
    import { Badge } from '@/components/ui/badge';
    import { Button } from '@/components/ui/button';
    import { Separator } from '@/components/ui/separator';
    import { AgentRun, AgentType } from '@/types';
    import { cn } from '@/lib/utils';
    import {
      ChevronDown,
      ChevronRight,
      FileSearch,
      UserCheck,
      ShieldAlert,
      BarChart3,
      FileText,
      Bot,
      CheckCircle2,
      XCircle,
      Clock,
      Loader2,
    } from 'lucide-react';

    // Agent display configuration
    const AGENT_DISPLAY: Record<AgentType, {
      label: string;
      icon: React.ComponentType<{ className?: string }>;
      description: string;
    }> = {
      orchestrator: {
        label: 'Orchestrator',
        icon: Bot,
        description: 'Pipeline coordination',
      },
      document_processor: {
        label: 'Document Processor',
        icon: FileSearch,
        description: 'OCR and data extraction',
      },
      identity_verifier: {
        label: 'Identity Verifier',
        icon: UserCheck,
        description: 'Identity cross-referencing',
      },
      sanctions_screener: {
        label: 'Sanctions Screener',
        icon: ShieldAlert,
        description: 'Sanctions list screening',
      },
      risk_scorer: {
        label: 'Risk Scorer',
        icon: BarChart3,
        description: 'Risk score calculation',
      },
      case_narrator: {
        label: 'Case Narrator',
        icon: FileText,
        description: 'Narrative generation',
      },
    };

    interface AgentResultsPanelProps {
      agentRuns: AgentRun[];
    }

    export function AgentResultsPanel({ agentRuns }: AgentResultsPanelProps) {
      const [expandedAgents, setExpandedAgents] = useState<Set<string>>(new Set());

      const toggleAgent = (id: string) => {
        setExpandedAgents(prev => {
          const next = new Set(prev);
          if (next.has(id)) {
            next.delete(id);
          } else {
            next.add(id);
          }
          return next;
        });
      };

      if (agentRuns.length === 0) {
        return (
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2 text-base">
                <Bot className="h-4 w-4" />
                Agent Results
              </CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-sm text-muted-foreground">
                No agents have processed this case yet.
              </p>
            </CardContent>
          </Card>
        );
      }

      return (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2 text-base">
              <Bot className="h-4 w-4" />
              Agent Results ({agentRuns.length} agents)
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-2 p-0">
            {agentRuns.map((run) => {
              const agentConfig = AGENT_DISPLAY[run.agent_type as AgentType];
              const isExpanded = expandedAgents.has(run.id);
              const Icon = agentConfig?.icon || Bot;

              return (
                <div key={run.id} className="border-b last:border-b-0">
                  {/* Agent header — always visible */}
                  <button
                    onClick={() => toggleAgent(run.id)}
                    className="flex w-full items-center gap-3 px-6 py-3 text-left hover:bg-muted/50 transition-colors"
                  >
                    {isExpanded ? (
                      <ChevronDown className="h-4 w-4 text-muted-foreground flex-shrink-0" />
                    ) : (
                      <ChevronRight className="h-4 w-4 text-muted-foreground flex-shrink-0" />
                    )}
                    <Icon className="h-4 w-4 flex-shrink-0" />
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2">
                        <span className="text-sm font-medium">
                          {agentConfig?.label || run.agent_type}
                        </span>
                        <AgentStatusBadge status={run.status} />
                      </div>
                      <p className="text-xs text-muted-foreground">
                        {agentConfig?.description || ''}
                      </p>
                    </div>
                    {run.confidence !== null && (
                      <span className="text-xs text-muted-foreground flex-shrink-0">
                        {Math.round(run.confidence * 100)}% confidence
                      </span>
                    )}
                  </button>

                  {/* Expanded detail */}
                  {isExpanded && run.output && (
                    <div className="px-6 pb-4 pl-14">
                      <div className="rounded-md border bg-muted/30 p-4">
                        <pre className="text-xs whitespace-pre-wrap overflow-auto max-h-64">
                          {JSON.stringify(run.output, null, 2)}
                        </pre>
                      </div>
                      {run.error && (
                        <div className="mt-2 rounded-md border border-destructive/20 bg-destructive/5 p-3">
                          <p className="text-xs text-destructive">{run.error}</p>
                        </div>
                      )}
                      <div className="mt-2 flex gap-4 text-xs text-muted-foreground">
                        {run.started_at && (
                          <span>Started: {new Date(run.started_at).toLocaleTimeString()}</span>
                        )}
                        {run.completed_at && (
                          <span>Completed: {new Date(run.completed_at).toLocaleTimeString()}</span>
                        )}
                      </div>
                    </div>
                  )}
                </div>
              );
            })}
          </CardContent>
        </Card>
      );
    }

    function AgentStatusBadge({ status }: { status: string }) {
      switch (status) {
        case 'completed':
          return (
            <Badge variant="outline" className="gap-1 bg-emerald-50 text-emerald-700 border-emerald-200 text-xs">
              <CheckCircle2 className="h-3 w-3" />
              Complete
            </Badge>
          );
        case 'failed':
          return (
            <Badge variant="outline" className="gap-1 bg-red-50 text-red-700 border-red-200 text-xs">
              <XCircle className="h-3 w-3" />
              Failed
            </Badge>
          );
        case 'running':
          return (
            <Badge variant="outline" className="gap-1 bg-blue-50 text-blue-700 border-blue-200 text-xs">
              <Loader2 className="h-3 w-3 animate-spin" />
              Running
            </Badge>
          );
        default:
          return (
            <Badge variant="outline" className="gap-1 text-xs">
              <Clock className="h-3 w-3" />
              Pending
            </Badge>
          );
      }
    }
    ```

    **Create `src/components/cases/evidence-section.tsx`:**

    Displays evidence links from the case narrative — connecting claims to specific agent results.

    ```typescript
    import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
    import { Badge } from '@/components/ui/badge';
    import { Link2, ExternalLink } from 'lucide-react';
    import { cn } from '@/lib/utils';

    interface EvidenceLink {
      claim: string;
      source: string;
      confidence: number;
    }

    interface EvidenceSectionProps {
      evidenceLinks: EvidenceLink[];
    }

    export function EvidenceSection({ evidenceLinks }: EvidenceSectionProps) {
      if (evidenceLinks.length === 0) {
        return null;
      }

      return (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2 text-base">
              <Link2 className="h-4 w-4" />
              Evidence Links ({evidenceLinks.length})
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {evidenceLinks.map((link, idx) => (
                <div
                  key={idx}
                  className="flex items-start gap-3 rounded-lg border p-3"
                >
                  <div className="flex-1">
                    <p className="text-sm font-medium">{link.claim}</p>
                    <p className="mt-1 text-xs text-muted-foreground">
                      Source: {link.source}
                    </p>
                  </div>
                  <Badge
                    variant="outline"
                    className={cn(
                      'flex-shrink-0 text-xs',
                      link.confidence >= 0.8 && 'bg-emerald-50 text-emerald-700 border-emerald-200',
                      link.confidence >= 0.5 && link.confidence < 0.8 && 'bg-amber-50 text-amber-700 border-amber-200',
                      link.confidence < 0.5 && 'bg-red-50 text-red-700 border-red-200',
                    )}
                  >
                    {Math.round(link.confidence * 100)}%
                  </Badge>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      );
    }
    ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - RiskProfileCard renders risk score circle, risk level badge, risk factors with progress bars, and scoring summary
    - RiskProfileCard shows "Risk scoring has not been completed" when riskScore is null
    - CaseNarrativeCard renders narrative paragraphs, key findings list, and recommended action badge
    - CaseNarrativeCard shows "Case narrative has not been generated" when narrative is null
    - AgentResultsPanel renders expandable agent cards with status badges
    - AgentResultsPanel shows agent output JSON when expanded
    - EvidenceSection renders linked evidence with confidence badges
    - All components handle null/empty data gracefully
  </verify>
  <done>Four case detail components created: RiskProfileCard (risk score visualization with factors), CaseNarrativeCard (AI narrative with key findings), AgentResultsPanel (expandable agent results), and EvidenceSection (evidence links with confidence). All handle null states for cases that haven't been fully processed.</done>
</task>

<task type="auto">
  <name>Task 3: Create case detail page composing all components</name>
  <files>src/app/dashboard/cases/[id]/page.tsx</files>
  <action>
    Create `src/app/dashboard/cases/[id]/page.tsx` — the case detail page that fetches data and composes all components.

    ```typescript
    'use client';

    import { useEffect, useState, useCallback } from 'react';
    import { useParams, useRouter } from 'next/navigation';
    import { Case, AgentRun } from '@/types';
    import { RiskScorerOutput, CaseNarratorOutput } from '@/types/agents';
    import { DashboardShell } from '@/components/layout/dashboard-shell';
    import { RiskProfileCard } from '@/components/cases/risk-profile-card';
    import { CaseNarrativeCard } from '@/components/cases/case-narrative-card';
    import { AgentResultsPanel } from '@/components/cases/agent-results-panel';
    import { EvidenceSection } from '@/components/cases/evidence-section';
    import { CaseStatusBadge } from '@/components/cases/case-status-badge';
    import { CaseRiskBadge } from '@/components/cases/case-risk-badge';
    import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
    import { Badge } from '@/components/ui/badge';
    import { Button } from '@/components/ui/button';
    import { Separator } from '@/components/ui/separator';
    import { ArrowLeft, Loader2, User, Mail, Calendar } from 'lucide-react';
    import Link from 'next/link';

    export default function CaseDetailPage() {
      const params = useParams();
      const router = useRouter();
      const caseId = params.id as string;

      const [caseData, setCaseData] = useState<Case | null>(null);
      const [agentRuns, setAgentRuns] = useState<AgentRun[]>([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState<string | null>(null);

      const fetchData = useCallback(async () => {
        if (!caseId) return;
        setLoading(true);
        setError(null);

        try {
          // Fetch case and agent runs in parallel
          const [caseResponse, runsResponse] = await Promise.all([
            fetch(`/api/cases/${caseId}`),
            fetch(`/api/cases/${caseId}/agent-runs`),
          ]);

          if (!caseResponse.ok) {
            throw new Error('Case not found');
          }

          const caseResult = await caseResponse.json();
          const runsResult = runsResponse.ok
            ? await runsResponse.json()
            : { agent_runs: [] };

          setCaseData(caseResult);
          setAgentRuns(runsResult.agent_runs || []);
        } catch (err) {
          setError(err instanceof Error ? err.message : 'Failed to load case');
        } finally {
          setLoading(false);
        }
      }, [caseId]);

      useEffect(() => {
        fetchData();
      }, [fetchData]);

      // Extract agent-specific results from agent_runs
      const riskScorerRun = agentRuns.find(r => r.agent_type === 'risk_scorer' && r.status === 'completed');
      const narratorRun = agentRuns.find(r => r.agent_type === 'case_narrator' && r.status === 'completed');

      const riskOutput = riskScorerRun?.output as unknown as RiskScorerOutput | null;
      const narratorOutput = narratorRun?.output as unknown as CaseNarratorOutput | null;

      if (loading) {
        return (
          <DashboardShell title="Loading...">
            <div className="flex items-center justify-center py-12">
              <Loader2 className="h-6 w-6 animate-spin text-muted-foreground" />
              <span className="ml-2 text-sm text-muted-foreground">Loading case details...</span>
            </div>
          </DashboardShell>
        );
      }

      if (error || !caseData) {
        return (
          <DashboardShell title="Error">
            <Card>
              <CardContent className="py-8 text-center">
                <p className="text-sm text-destructive">{error || 'Case not found'}</p>
                <Link href="/dashboard/cases">
                  <Button variant="link" className="mt-2">
                    Back to Case Queue
                  </Button>
                </Link>
              </CardContent>
            </Card>
          </DashboardShell>
        );
      }

      return (
        <DashboardShell
          title={caseData.applicant_name}
          description={`Case ID: ${caseData.id}`}
          actions={
            <Link href="/dashboard/cases">
              <Button variant="outline" size="sm" className="gap-1.5">
                <ArrowLeft className="h-4 w-4" />
                Back to Queue
              </Button>
            </Link>
          }
        >
          {/* Case Header Info */}
          <Card>
            <CardContent className="flex items-center gap-6 py-4">
              <div className="flex items-center gap-2">
                <User className="h-4 w-4 text-muted-foreground" />
                <span className="text-sm font-medium">{caseData.applicant_name}</span>
              </div>
              {caseData.applicant_email && (
                <div className="flex items-center gap-2">
                  <Mail className="h-4 w-4 text-muted-foreground" />
                  <span className="text-sm text-muted-foreground">{caseData.applicant_email}</span>
                </div>
              )}
              <div className="flex items-center gap-2">
                <Calendar className="h-4 w-4 text-muted-foreground" />
                <span className="text-sm text-muted-foreground">
                  {new Date(caseData.created_at).toLocaleDateString('en-US', {
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric',
                  })}
                </span>
              </div>
              <Separator orientation="vertical" className="h-6" />
              <CaseStatusBadge status={caseData.status} />
              <CaseRiskBadge
                riskLevel={caseData.risk_level}
                riskScore={caseData.risk_score}
              />
            </CardContent>
          </Card>

          {/* Two-column layout: Left = risk profile + narrative, Right = agent results */}
          <div className="grid gap-6 lg:grid-cols-3">
            {/* Left column — 2/3 width */}
            <div className="space-y-6 lg:col-span-2">
              <RiskProfileCard
                riskScore={caseData.risk_score}
                riskLevel={caseData.risk_level}
                riskFactors={riskOutput?.risk_factors || []}
                requiresManualReview={riskOutput?.requires_manual_review ?? false}
                scoringSummary={riskOutput?.scoring_summary}
              />

              <CaseNarrativeCard
                narrative={caseData.narrative}
                keyFindings={narratorOutput?.key_findings || []}
                recommendedAction={narratorOutput?.recommended_action || null}
              />

              <EvidenceSection
                evidenceLinks={narratorOutput?.evidence_links || []}
              />

              {/* Decision section placeholder — built in Plan 04 */}
              {caseData.status === 'review' && !caseData.decision && (
                <Card className="border-dashed border-2 border-primary/20">
                  <CardContent className="py-8 text-center">
                    <p className="text-sm text-muted-foreground">
                      Decision workflow will appear here when the case is ready for review.
                    </p>
                  </CardContent>
                </Card>
              )}

              {/* Show existing decision if made */}
              {caseData.decision && (
                <Card>
                  <CardHeader>
                    <CardTitle className="text-base">Officer Decision</CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-2">
                    <Badge
                      variant="outline"
                      className={
                        caseData.decision === 'approved'
                          ? 'bg-emerald-50 text-emerald-700 border-emerald-200'
                          : caseData.decision === 'denied'
                            ? 'bg-red-50 text-red-700 border-red-200'
                            : 'bg-purple-50 text-purple-700 border-purple-200'
                      }
                    >
                      {caseData.decision.charAt(0).toUpperCase() + caseData.decision.slice(1)}
                    </Badge>
                    {caseData.decision_justification && (
                      <p className="text-sm text-muted-foreground mt-2">
                        {caseData.decision_justification}
                      </p>
                    )}
                  </CardContent>
                </Card>
              )}
            </div>

            {/* Right column — 1/3 width */}
            <div className="space-y-6">
              <AgentResultsPanel agentRuns={agentRuns} />
            </div>
          </div>
        </DashboardShell>
      );
    }
    ```

    KEY DESIGN DECISIONS:
    - **Two-column layout** — left 2/3 for the primary review flow (risk profile, narrative, evidence, decision), right 1/3 for agent details drill-down.
    - **Parallel data fetching** — case and agent runs fetched simultaneously.
    - **Type casting for agent outputs** — agent_runs store JSON output in `output` column. We cast to typed outputs (RiskScorerOutput, CaseNarratorOutput) using `as unknown as T`.
    - **Graceful degradation** — every section handles null data. A case with no risk scoring shows "not completed" instead of crashing. This supports viewing cases at any pipeline stage.
    - **Decision placeholder** — shows a dashed border card for cases in 'review' status that don't have a decision yet. Plan 04 replaces this with the actual decision workflow component.
    - **Existing decision display** — if decision already made, shows the decision badge and justification.

    IMPORTANT: When importing from `@/types/agents`, check if the types are re-exported from `@/types` index (they should be via `export * from './agents'`). If so, import from `@/types` instead. If not, import directly from `@/types/agents`.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Navigate to /dashboard/cases/[some-uuid] — page renders
    - With valid case ID: shows case header with applicant info, status badge, risk badge
    - With valid case + agent runs: shows risk profile card with score and factors
    - With valid case + narrative: shows narrative card with key findings
    - With case in 'review' status and no decision: shows decision placeholder
    - With case that has decision: shows decision badge and justification
    - With invalid case ID: shows error state with back link
    - Agent results panel shows expandable agent cards
    - Evidence section shows linked claims with confidence badges
    - Back to Queue button navigates to /dashboard/cases
    - Two-column layout collapses to single column on smaller screens
  </verify>
  <done>Case detail page complete with full risk profile view. Two-column layout: risk profile + narrative + evidence on left, agent drill-down on right. All components handle null data gracefully for cases at any pipeline stage. Decision placeholder ready for Plan 04 to replace with actual workflow. (DASH-03)</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for all new files
2. GET /api/cases/[id] returns case data or 404
3. GET /api/cases/[id]/agent-runs returns agent runs or 404
4. /dashboard/cases/[id] page renders with all components
5. RiskProfileCard shows risk score circle with color coding, factors with progress bars
6. CaseNarrativeCard shows narrative text, key findings, and AI recommendation badge
7. AgentResultsPanel shows expandable agent cards with JSON output
8. EvidenceSection shows claims linked to sources with confidence
9. All components gracefully handle null/missing data
10. Two-column responsive layout works on different screen sizes
</verification>

<success_criteria>
- Risk profile view shows synthesized assessment with drill-down into evidence (DASH-03 - Phase 6 Success Criterion #2)
- Risk score displayed prominently with color-coded level indicator
- Risk factors breakdown shows weighted contributions
- Case narrative presents AI-generated assessment with key findings
- Evidence links connect claims to specific agent results
- Agent results panel enables drill-down into raw processing data
- Page handles cases at any pipeline stage (partial data is OK)
</success_criteria>

<output>
After completion, create `.planning/phases/06-dashboard-core/06-03-SUMMARY.md`
</output>
