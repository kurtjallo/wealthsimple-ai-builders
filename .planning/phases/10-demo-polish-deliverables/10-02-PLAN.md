---
phase: 10-demo-polish-deliverables
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - vercel.json
  - next.config.ts
  - .env.production.example
  - src/app/api/health/route.ts
autonomous: false

user_setup:
  - service: vercel
    why: "Production deployment hosting"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Settings -> API -> anon public key"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Settings -> API -> service_role key"
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys"
      - name: MISTRAL_API_KEY
        source: "Mistral AI Console -> API Keys"
    dashboard_config:
      - task: "Import Git repository and configure project"
        location: "Vercel Dashboard -> Add New Project -> Import Git Repository"

must_haves:
  truths:
    - "Application deploys to Vercel and is accessible via a public URL"
    - "All environment variables are configured in the Vercel project"
    - "Health check endpoint returns OK from the production URL"
    - "The deployed app loads the dashboard with demo data"
    - "No build errors or runtime crashes on production"
  artifacts:
    - path: "vercel.json"
      provides: "Vercel deployment configuration with build settings and headers"
      contains: "framework"
    - path: ".env.production.example"
      provides: "Production environment variable template"
      contains: "NEXT_PUBLIC_SUPABASE_URL"
    - path: "next.config.ts"
      provides: "Next.js config updated for production build optimization"
      contains: "output"
  key_links:
    - from: "vercel.json"
      to: "next.config.ts"
      via: "Vercel uses Next.js framework detection"
      pattern: "framework.*next"
    - from: "src/app/api/health/route.ts"
      to: "production URL"
      via: "accessible at /api/health"
      pattern: "GET.*health"
---

<objective>
Configure the project for Vercel deployment, create the production configuration, and deploy the application to a public URL.

Purpose: The working prototype must be accessible via a public Vercel URL for Wealthsimple reviewers (DELIV-01). This plan handles all production build configuration, deployment settings, and the actual deployment process.

Output: A live, publicly accessible deployment of the KYC/AML Operations Orchestrator at a Vercel URL, with all environment variables configured and health check passing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@next.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure production build and Vercel deployment settings</name>
  <files>vercel.json, next.config.ts, .env.production.example</files>
  <action>
    1. Create `vercel.json` with deployment configuration:

    ```json
    {
      "$schema": "https://openapi.vercel.sh/vercel.json",
      "framework": "nextjs",
      "buildCommand": "npm run build",
      "installCommand": "npm install",
      "regions": ["iad1"],
      "headers": [
        {
          "source": "/api/(.*)",
          "headers": [
            { "key": "Cache-Control", "value": "no-store, max-age=0" },
            { "key": "X-Content-Type-Options", "value": "nosniff" }
          ]
        }
      ],
      "functions": {
        "src/app/api/**/*.ts": {
          "maxDuration": 60
        }
      }
    }
    ```

    Notes on config choices:
    - `regions: ["iad1"]` — US East (Virginia), close to typical Supabase deployment region
    - `maxDuration: 60` — Agent processing API routes may take longer than the default 10s
    - API routes should not be cached (real-time data)
    - No special rewrites needed — Next.js App Router handles routing

    2. Update `next.config.ts` for production optimization:

    Read the existing `next.config.ts` first, then add/modify these settings:

    ```typescript
    import type { NextConfig } from "next";

    const nextConfig: NextConfig = {
      // Existing settings...

      // Production optimizations
      output: 'standalone', // Optimized for serverless deployment
      poweredByHeader: false, // Remove X-Powered-By header

      // Allow external images if demo docs use external URLs
      images: {
        remotePatterns: [
          {
            protocol: 'https',
            hostname: '**.supabase.co',
          },
        ],
      },

      // Suppress build warnings for demo
      eslint: {
        ignoreDuringBuilds: false, // Keep ESLint checks
      },
      typescript: {
        ignoreBuildErrors: false, // Keep type checking
      },
    };

    export default nextConfig;
    ```

    IMPORTANT: Do NOT set `ignoreBuildErrors: true` — if the build has type errors, fix them rather than suppressing. This is a demo for Wealthsimple engineers who will inspect the code.

    3. Create `.env.production.example` documenting all required production environment variables:

    ```
    # Supabase (same project as development)
    NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
    NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
    SUPABASE_SERVICE_ROLE_KEY=eyJ...

    # Anthropic (Claude Agent SDK)
    ANTHROPIC_API_KEY=sk-ant-...

    # Mistral (OCR)
    MISTRAL_API_KEY=...

    # NOTE: These must be set in Vercel Dashboard -> Settings -> Environment Variables
    # Do NOT commit real values to the repository.
    ```

    4. Verify the build works locally before deploying:
    - Run `npm run build` and confirm it completes with no errors
    - If there are type errors or build issues, fix them before proceeding
    - Check that all pages render in the build output
  </action>
  <verify>
    - `vercel.json` exists with valid JSON
    - `next.config.ts` has `output: 'standalone'` set
    - `.env.production.example` lists all 5 environment variables
    - `npm run build` completes successfully with no errors
    - No TypeScript errors during build
    - Build output shows all expected pages and API routes
  </verify>
  <done>
    Production build configuration complete. Build passes locally. Vercel deployment config created with appropriate serverless function timeouts and security headers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy to Vercel via CLI</name>
  <files></files>
  <action>
    Deploy the application to Vercel using the Vercel CLI.

    1. Install Vercel CLI globally if not present:
    ```bash
    npm install -g vercel
    ```

    2. Log in to Vercel (this may require authentication):
    ```bash
    vercel login
    ```
    If authentication fails, this becomes a checkpoint for the user.

    3. Link the project to Vercel:
    ```bash
    vercel link
    ```
    Follow prompts: select the user's Vercel account, set up and deploy, confirm settings.

    4. Set environment variables via CLI:
    ```bash
    vercel env add NEXT_PUBLIC_SUPABASE_URL production
    vercel env add NEXT_PUBLIC_SUPABASE_ANON_KEY production
    vercel env add SUPABASE_SERVICE_ROLE_KEY production
    vercel env add ANTHROPIC_API_KEY production
    vercel env add MISTRAL_API_KEY production
    ```
    Each command will prompt for the value — pull from `.env.local`.

    Alternatively, if the user has already set env vars in the Vercel dashboard, skip this step.

    5. Deploy to production:
    ```bash
    vercel --prod
    ```

    6. Capture the production URL from the deployment output.

    7. Verify the deployment:
    ```bash
    curl https://YOUR-APP.vercel.app/api/health
    ```
    Expected: `{"status":"ok","checks":{"server":"ok","database":"ok","claude":"ok"}}`

    8. Verify the app loads in browser by checking:
    ```bash
    curl -s https://YOUR-APP.vercel.app | head -50
    ```
    Should return HTML with "KYC/AML" in the title.

    IMPORTANT: If Vercel CLI authentication fails or env vars need to be set via dashboard, create a checkpoint for the user rather than blocking.
  </action>
  <verify>
    - `vercel --prod` completes successfully and outputs a production URL
    - `curl https://YOUR-APP.vercel.app/api/health` returns `status: "ok"`
    - The app loads in a browser at the production URL
    - No 500 errors on the main pages
    - Demo data is visible (cases load from Supabase)
  </verify>
  <done>
    Application deployed to Vercel production. Public URL is accessible. Health check passes. Demo data loads from Supabase.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Production deployment of the KYC/AML Operations Orchestrator on Vercel</what-built>
  <how-to-verify>
    1. Open the Vercel production URL in your browser
    2. Verify the dashboard loads without errors
    3. Verify demo cases are visible in the case queue (should see 5 cases)
    4. Click into Case 1 (Sarah Chen) — verify risk profile and agent results load
    5. Click into Case 2 (Viktor Petrov) — verify the sanctions match is visible
    6. Check that the agent visualization shows status correctly for Case 5 (processing)
    7. Visit /api/health — should return all checks "ok"
    8. Note the production URL for the demo video and submission
  </how-to-verify>
  <resume-signal>Type "approved" with the production URL, or describe any issues that need fixing</resume-signal>
</task>

</tasks>

<verification>
1. `vercel.json` exists with correct framework and function configuration
2. `npm run build` passes locally with no errors
3. Application is deployed to Vercel production
4. Production URL is accessible and returns the dashboard
5. Health check at /api/health returns "ok" status
6. Demo cases are visible and interactive at the production URL
7. No console errors or 500 responses on key pages
</verification>

<success_criteria>
- Working prototype accessible via URL (DELIV-01)
- All environment variables configured in Vercel (DEPLOY-01 verification)
- Production build optimized with standalone output
- Health check confirms database, Claude, and server connectivity
</success_criteria>

<output>
After completion, create `.planning/phases/10-demo-polish-deliverables/10-02-SUMMARY.md`
Record the production URL in the summary for use by subsequent plans.
</output>
