---
phase: 09-regulatory-audit-trail
plan: 04
type: execute
wave: 2
depends_on: ["09-02"]
files_modified:
  - src/components/audit/compliance-badge.tsx
  - src/components/audit/str-workflow-panel.tsx
  - src/components/audit/decision-panel.tsx
autonomous: true

must_haves:
  truths:
    - "FINTRAC compliance markers are visible on the dashboard indicating the system meets regulatory requirements"
    - "STR filing workflow has a dedicated panel clearly marked as human-only with FINTRAC regulatory context displayed"
    - "Decision panel enforces human-in-the-loop by requiring officer_id and justification before enabling approve/deny/escalate buttons"
    - "AI recommendation is displayed as advisory only — clearly labeled that the officer makes the final decision"
    - "Record-keeping notice (5+ year retention) is visible on audit-related views"
  artifacts:
    - path: "src/components/audit/compliance-badge.tsx"
      provides: "Reusable compliance status badge showing FINTRAC alignment"
      exports: ["ComplianceBadge", "RecordRetentionNotice"]
    - path: "src/components/audit/str-workflow-panel.tsx"
      provides: "STR filing workflow UI panel with FINTRAC context and human-only enforcement"
      exports: ["STRWorkflowPanel"]
    - path: "src/components/audit/decision-panel.tsx"
      provides: "Enhanced decision panel with human-in-the-loop enforcement at the UI level"
      exports: ["DecisionPanel"]
  key_links:
    - from: "src/components/audit/decision-panel.tsx"
      to: "/api/cases/[id]/decide"
      via: "submits decisions to the validated API endpoint"
      pattern: "fetch.*api/cases.*decide"
    - from: "src/components/audit/str-workflow-panel.tsx"
      to: "/api/cases/[id]/str"
      via: "submits STR referral to the validated API endpoint"
      pattern: "fetch.*api/cases.*str"
    - from: "src/components/audit/str-workflow-panel.tsx"
      to: "src/components/audit/compliance-badge.tsx"
      via: "displays ComplianceBadge and RecordRetentionNotice"
      pattern: "import.*ComplianceBadge.*from.*compliance-badge"
---

<objective>
Build the UI components that make regulatory compliance visible and enforce human-in-the-loop at the interface level. This includes FINTRAC compliance badges, a dedicated STR filing workflow panel with regulatory context, and an enhanced decision panel that requires officer identification and justification before enabling action buttons.

Purpose: Regulatory compliance must be VISIBLE, not just enforced. The demo needs to show that the system is production-aware: the officer sees their authority, the AI's role is clearly advisory, STR filing is marked as human-only with FINTRAC context, and record-keeping requirements are displayed. This is what makes the project credible for Wealthsimple.

Output: Three React components — ComplianceBadge (reusable marker), STRWorkflowPanel (STR filing UI), and DecisionPanel (approve/deny/escalate with human-in-the-loop enforcement).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-regulatory-audit-trail/09-02-SUMMARY.md
@src/types/index.ts (Case, CaseStatus, DecisionType, RiskLevel)
@src/components/ui/card.tsx
@src/components/ui/badge.tsx
@src/components/ui/button.tsx
@src/components/ui/input.tsx
@src/components/ui/textarea.tsx (shadcn Textarea component)
@src/components/ui/alert.tsx (shadcn Alert component)
@src/components/ui/separator.tsx (shadcn Separator component)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create compliance badge and STR workflow panel components</name>
  <files>src/components/audit/compliance-badge.tsx, src/components/audit/str-workflow-panel.tsx</files>
  <action>
    **1. Create `src/components/audit/compliance-badge.tsx`:**

    Reusable compliance markers that show FINTRAC alignment throughout the dashboard.

    ```typescript
    'use client';

    import { Badge } from '@/components/ui/badge';
    import { Shield, Clock, AlertTriangle } from 'lucide-react';

    /**
     * FINTRAC compliance badge — shows that the system meets regulatory requirements.
     * Display on dashboard header, case detail views, and audit trail.
     */
    export function ComplianceBadge({
      variant = 'default',
    }: {
      variant?: 'default' | 'compact' | 'detailed';
    }) {
      if (variant === 'compact') {
        return (
          <Badge variant="outline" className="text-xs gap-1 font-normal text-green-700 border-green-300 bg-green-50">
            <Shield className="h-3 w-3" />
            FINTRAC
          </Badge>
        );
      }

      if (variant === 'detailed') {
        return (
          <div className="flex items-center gap-2 rounded-md border border-green-200 bg-green-50 px-3 py-2">
            <Shield className="h-4 w-4 text-green-600" />
            <div>
              <p className="text-sm font-medium text-green-800">FINTRAC/PCMLTFA Compliant</p>
              <p className="text-xs text-green-600">
                Full audit trail with human-in-the-loop enforcement
              </p>
            </div>
          </div>
        );
      }

      // default
      return (
        <Badge variant="outline" className="gap-1 font-normal text-green-700 border-green-300 bg-green-50">
          <Shield className="h-3.5 w-3.5" />
          FINTRAC/PCMLTFA Compliant
        </Badge>
      );
    }

    /**
     * Record retention notice — displays the 5-year FINTRAC requirement.
     * Show on audit trail views and export dialogs.
     */
    export function RecordRetentionNotice() {
      return (
        <div className="flex items-start gap-2 rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-xs">
          <Clock className="h-3.5 w-3.5 text-amber-600 mt-0.5 shrink-0" />
          <div className="text-amber-800">
            <span className="font-medium">Record Retention:</span>{' '}
            PCMLTFA requires all compliance records to be retained for a minimum of 5 years
            from the date of the last business transaction or activity.
          </div>
        </div>
      );
    }

    /**
     * Human-only indicator — shows that a specific action requires human authority.
     * Use on STR filing, decision panels, and any action that AI cannot perform.
     */
    export function HumanOnlyIndicator({ action }: { action: string }) {
      return (
        <div className="flex items-center gap-1.5 text-xs text-amber-700">
          <AlertTriangle className="h-3.5 w-3.5" />
          <span>
            <span className="font-medium">{action}</span> requires human officer authorization
          </span>
        </div>
      );
    }
    ```

    **2. Create `src/components/audit/str-workflow-panel.tsx`:**

    The STR (Suspicious Transaction Report) workflow panel. This is a critical demo piece — it shows the system understands that STR filing is exclusively human.

    ```typescript
    'use client';

    import { useState, useEffect } from 'react';
    import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
    import { Button } from '@/components/ui/button';
    import { Badge } from '@/components/ui/badge';
    import { Separator } from '@/components/ui/separator';
    import { AlertTriangle, FileText, Shield, User, ExternalLink } from 'lucide-react';
    import { ComplianceBadge, HumanOnlyIndicator, RecordRetentionNotice } from './compliance-badge';

    interface STRWorkflowPanelProps {
      caseId: string;
      riskLevel?: string;
      riskScore?: number;
      officerId?: string;
      officerName?: string;
      onSTRFiled?: () => void;
    }

    interface FintracContext {
      regulation: string;
      requirement: string;
      summary: string;
      human_only_rationale: string;
      filing_deadline: string;
      record_keeping: string;
    }

    export function STRWorkflowPanel({
      caseId,
      riskLevel,
      riskScore,
      officerId,
      officerName,
      onSTRFiled,
    }: STRWorkflowPanelProps) {
      const [reason, setReason] = useState('');
      const [indicators, setIndicators] = useState<string[]>([]);
      const [newIndicator, setNewIndicator] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState<string | null>(null);
      const [success, setSuccess] = useState(false);
      const [fintracContext, setFintracContext] = useState<FintracContext | null>(null);

      // Load FINTRAC regulatory context on mount
      useEffect(() => {
        async function loadContext() {
          try {
            const response = await fetch(`/api/cases/${caseId}/str`);
            if (response.ok) {
              const data = await response.json();
              setFintracContext(data.regulatory_context);
            }
          } catch {
            // Context is informational — don't block on failure
          }
        }
        loadContext();
      }, [caseId]);

      const addIndicator = () => {
        if (newIndicator.trim()) {
          setIndicators(prev => [...prev, newIndicator.trim()]);
          setNewIndicator('');
        }
      };

      const removeIndicator = (index: number) => {
        setIndicators(prev => prev.filter((_, i) => i !== index));
      };

      const handleSubmit = async () => {
        if (!officerId) {
          setError('Officer identification required. Please log in as a compliance officer.');
          return;
        }
        if (reason.trim().length < 20) {
          setError('Please provide a detailed reason (at least 20 characters) explaining the suspicious indicators.');
          return;
        }

        setLoading(true);
        setError(null);

        try {
          const response = await fetch(`/api/cases/${caseId}/str`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              officer_id: officerId,
              officer_name: officerName,
              reason: reason.trim(),
              suspicious_indicators: indicators,
            }),
          });

          const data = await response.json();

          if (!response.ok) {
            setError(data.error || 'Failed to submit STR referral');
            return;
          }

          setSuccess(true);
          onSTRFiled?.();
        } catch (err) {
          setError('Network error. Please try again.');
        } finally {
          setLoading(false);
        }
      };

      if (success) {
        return (
          <Card className="border-amber-300 bg-amber-50/50">
            <CardContent className="pt-6">
              <div className="text-center space-y-3">
                <div className="flex justify-center">
                  <div className="h-12 w-12 rounded-full bg-amber-100 flex items-center justify-center">
                    <FileText className="h-6 w-6 text-amber-600" />
                  </div>
                </div>
                <h3 className="font-semibold text-amber-900">STR Referral Recorded</h3>
                <p className="text-sm text-amber-700">
                  This case has been referred for STR filing. The referral has been logged
                  in the audit trail. FINTRAC filing must be completed within 30 days.
                </p>
                <RecordRetentionNotice />
              </div>
            </CardContent>
          </Card>
        );
      }

      return (
        <Card className="border-amber-200">
          <CardHeader className="pb-3">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <AlertTriangle className="h-5 w-5 text-amber-500" />
                <CardTitle className="text-base">Suspicious Transaction Report</CardTitle>
              </div>
              <HumanOnlyIndicator action="STR Filing" />
            </div>
          </CardHeader>
          <CardContent className="space-y-4">
            {/* FINTRAC Regulatory Context */}
            {fintracContext && (
              <div className="rounded-lg border bg-muted/30 p-3 space-y-2 text-xs">
                <div className="flex items-center gap-1.5 font-medium text-foreground">
                  <Shield className="h-3.5 w-3.5" />
                  Regulatory Context
                </div>
                <p className="text-muted-foreground">{fintracContext.summary}</p>
                <p className="text-muted-foreground italic">{fintracContext.human_only_rationale}</p>
                <div className="flex items-center gap-1 text-amber-700">
                  <ExternalLink className="h-3 w-3" />
                  <span>{fintracContext.regulation} — {fintracContext.requirement}</span>
                </div>
              </div>
            )}

            {/* Risk context */}
            {(riskLevel || riskScore != null) && (
              <div className="flex items-center gap-2">
                <span className="text-sm text-muted-foreground">Current Risk:</span>
                {riskScore != null && (
                  <Badge variant="outline">{riskScore}/100</Badge>
                )}
                {riskLevel && (
                  <Badge
                    variant={riskLevel === 'critical' || riskLevel === 'high' ? 'destructive' : 'secondary'}
                  >
                    {riskLevel}
                  </Badge>
                )}
              </div>
            )}

            <Separator />

            {/* Officer identification */}
            <div className="flex items-center gap-2 text-sm">
              <User className="h-4 w-4 text-muted-foreground" />
              <span className="text-muted-foreground">Filing Officer:</span>
              <span className="font-medium">
                {officerName || officerId || 'Not identified'}
              </span>
            </div>

            {/* Reason for STR */}
            <div className="space-y-1.5">
              <label className="text-sm font-medium">
                Reason for STR Referral <span className="text-red-500">*</span>
              </label>
              <textarea
                className="flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                placeholder="Describe the suspicious indicators and why this case warrants an STR filing..."
                value={reason}
                onChange={(e) => setReason(e.target.value)}
                disabled={loading}
              />
              <p className="text-xs text-muted-foreground">
                Minimum 20 characters. Document the specific suspicious indicators observed.
              </p>
            </div>

            {/* Suspicious indicators */}
            <div className="space-y-1.5">
              <label className="text-sm font-medium">Suspicious Indicators</label>
              <div className="flex gap-2">
                <input
                  className="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50"
                  placeholder="Add an indicator..."
                  value={newIndicator}
                  onChange={(e) => setNewIndicator(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && addIndicator()}
                  disabled={loading}
                />
                <Button
                  variant="outline"
                  size="sm"
                  onClick={addIndicator}
                  disabled={loading || !newIndicator.trim()}
                >
                  Add
                </Button>
              </div>
              {indicators.length > 0 && (
                <div className="flex flex-wrap gap-1 mt-1">
                  {indicators.map((ind, i) => (
                    <Badge key={i} variant="secondary" className="text-xs cursor-pointer" onClick={() => removeIndicator(i)}>
                      {ind} x
                    </Badge>
                  ))}
                </div>
              )}
            </div>

            {/* Error display */}
            {error && (
              <div className="rounded-md bg-red-50 border border-red-200 px-3 py-2 text-sm text-red-700">
                {error}
              </div>
            )}

            <Separator />

            {/* Submit button */}
            <div className="space-y-2">
              <Button
                className="w-full bg-amber-600 hover:bg-amber-700"
                onClick={handleSubmit}
                disabled={loading || !officerId || reason.trim().length < 20}
              >
                {loading ? 'Submitting...' : 'Refer Case for STR Filing'}
              </Button>
              <p className="text-xs text-center text-muted-foreground">
                This action will be recorded in the audit trail and cannot be undone.
                FINTRAC filing must be completed within 30 days.
              </p>
            </div>

            <RecordRetentionNotice />
          </CardContent>
        </Card>
      );
    }
    ```

    KEY DESIGN for STR panel:
    - **Loads FINTRAC context on mount** via GET /api/cases/{id}/str
    - **Human-only indicator** prominently displayed
    - **Regulatory context box** shows PCMLTFA requirements
    - **Officer identification** displayed (required)
    - **Reason field** with minimum 20 characters (matches server validation)
    - **Suspicious indicators** as tag-like badges
    - **Submit disabled** until all requirements met
    - **Success state** shows confirmation with record retention notice
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - compliance-badge.tsx exports: ComplianceBadge, RecordRetentionNotice, HumanOnlyIndicator
    - ComplianceBadge renders in 3 variants: default, compact, detailed
    - RecordRetentionNotice mentions 5-year PCMLTFA requirement
    - str-workflow-panel.tsx exports: STRWorkflowPanel
    - STRWorkflowPanel loads FINTRAC context on mount from GET /api/cases/{id}/str
    - STRWorkflowPanel submits to POST /api/cases/{id}/str with officer_id, reason, indicators
    - Submit button disabled when officer_id missing or reason < 20 chars
    - FINTRAC regulatory context displayed prominently
    - Human-only indicator visible in panel header
    - Success state shows STR referral confirmation
  </verify>
  <done>Compliance badge components created (FINTRAC badge, retention notice, human-only indicator). STR workflow panel built with FINTRAC regulatory context display, human-only enforcement, mandatory reason with indicators, and success confirmation. All components use shadcn UI.</done>
</task>

<task type="auto">
  <name>Task 2: Create enhanced decision panel with human-in-the-loop UI enforcement</name>
  <files>src/components/audit/decision-panel.tsx</files>
  <action>
    Create `src/components/audit/decision-panel.tsx` — the enhanced decision panel that enforces human-in-the-loop at the UI level. This component replaces or wraps the existing decision UI from Phase 6/8 with regulatory compliance features.

    ```typescript
    'use client';

    import { useState } from 'react';
    import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
    import { Button } from '@/components/ui/button';
    import { Badge } from '@/components/ui/badge';
    import { Separator } from '@/components/ui/separator';
    import {
      CheckCircle,
      XCircle,
      AlertTriangle,
      User,
      Bot,
      Shield,
      ChevronDown,
      ChevronUp,
    } from 'lucide-react';
    import { ComplianceBadge, HumanOnlyIndicator } from './compliance-badge';

    interface DecisionPanelProps {
      caseId: string;
      caseStatus: string;
      riskScore?: number;
      riskLevel?: string;
      aiRecommendation?: string;    // From Case Narrator: 'approve' | 'deny' | 'escalate'
      aiRecommendationReason?: string; // From Case Narrator narrative
      officerId?: string;
      officerName?: string;
      onDecision?: (decision: string) => void;
      onSTRReferral?: () => void;
    }

    export function DecisionPanel({
      caseId,
      caseStatus,
      riskScore,
      riskLevel,
      aiRecommendation,
      aiRecommendationReason,
      officerId,
      officerName,
      onDecision,
      onSTRReferral,
    }: DecisionPanelProps) {
      const [justification, setJustification] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState<string | null>(null);
      const [success, setSuccess] = useState<string | null>(null);
      const [showAIDetail, setShowAIDetail] = useState(false);

      // Case must be in a decidable state
      const decidableStatuses = ['review', 'processing', 'escalated'];
      const canDecide = decidableStatuses.includes(caseStatus);
      const isDecided = ['approved', 'denied'].includes(caseStatus);

      // Human must be identified and provide justification
      const hasOfficer = !!officerId;
      const hasJustification = justification.trim().length >= 10;
      const canSubmit = canDecide && hasOfficer && hasJustification && !loading;

      const handleDecision = async (decision: 'approved' | 'denied' | 'escalated') => {
        if (!canSubmit) return;

        setLoading(true);
        setError(null);

        try {
          const response = await fetch(`/api/cases/${caseId}/decide`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              officer_id: officerId,
              officer_name: officerName,
              decision,
              justification: justification.trim(),
            }),
          });

          const data = await response.json();

          if (!response.ok) {
            setError(data.error || 'Decision failed');
            return;
          }

          setSuccess(decision);
          onDecision?.(decision);
        } catch (err) {
          setError('Network error. Please try again.');
        } finally {
          setLoading(false);
        }
      };

      // Success state
      if (success) {
        const successConfig: Record<string, { icon: typeof CheckCircle; color: string; label: string }> = {
          approved: { icon: CheckCircle, color: 'text-green-600', label: 'Approved' },
          denied: { icon: XCircle, color: 'text-red-600', label: 'Denied' },
          escalated: { icon: AlertTriangle, color: 'text-amber-600', label: 'Escalated' },
        };
        const config = successConfig[success] || successConfig.escalated;
        const Icon = config.icon;

        return (
          <Card className="border-green-200 bg-green-50/30">
            <CardContent className="pt-6">
              <div className="text-center space-y-2">
                <Icon className={`h-8 w-8 mx-auto ${config.color}`} />
                <h3 className="font-semibold">Case {config.label}</h3>
                <p className="text-sm text-muted-foreground">
                  Decision by {officerName || officerId} has been recorded in the audit trail.
                </p>
              </div>
            </CardContent>
          </Card>
        );
      }

      // Already decided state
      if (isDecided) {
        return (
          <Card className="border-muted">
            <CardContent className="pt-6">
              <div className="text-center space-y-2 text-muted-foreground">
                <Shield className="h-6 w-6 mx-auto" />
                <p className="text-sm">
                  Case has been {caseStatus}. Decision recorded in audit trail.
                </p>
              </div>
            </CardContent>
          </Card>
        );
      }

      return (
        <Card>
          <CardHeader className="pb-3">
            <div className="flex items-center justify-between">
              <CardTitle className="text-base flex items-center gap-2">
                <Shield className="h-5 w-5 text-muted-foreground" />
                Compliance Decision
              </CardTitle>
              <ComplianceBadge variant="compact" />
            </div>
            <HumanOnlyIndicator action="Final compliance decision" />
          </CardHeader>
          <CardContent className="space-y-4">
            {/* AI Recommendation (advisory only) */}
            {aiRecommendation && (
              <div className="rounded-lg border bg-blue-50/50 border-blue-200 p-3 space-y-2">
                <div
                  className="flex items-center justify-between cursor-pointer"
                  onClick={() => setShowAIDetail(!showAIDetail)}
                >
                  <div className="flex items-center gap-2">
                    <Bot className="h-4 w-4 text-blue-500" />
                    <span className="text-sm font-medium text-blue-800">
                      AI Recommendation: <span className="capitalize">{aiRecommendation}</span>
                    </span>
                  </div>
                  <div className="flex items-center gap-2">
                    <Badge variant="outline" className="text-xs text-blue-600 border-blue-300">
                      Advisory Only
                    </Badge>
                    {showAIDetail ? (
                      <ChevronUp className="h-4 w-4 text-blue-400" />
                    ) : (
                      <ChevronDown className="h-4 w-4 text-blue-400" />
                    )}
                  </div>
                </div>
                {showAIDetail && aiRecommendationReason && (
                  <p className="text-xs text-blue-700 mt-2 leading-relaxed">
                    {aiRecommendationReason}
                  </p>
                )}
                <p className="text-[11px] text-blue-500 italic">
                  Per REG-02: AI recommendations are advisory. The compliance officer makes the final determination.
                </p>
              </div>
            )}

            {/* Risk context */}
            {(riskLevel || riskScore != null) && (
              <div className="flex items-center gap-2 text-sm">
                <span className="text-muted-foreground">Risk Assessment:</span>
                {riskScore != null && <Badge variant="outline">{riskScore}/100</Badge>}
                {riskLevel && (
                  <Badge
                    variant={
                      riskLevel === 'critical' ? 'destructive' :
                      riskLevel === 'high' ? 'destructive' :
                      riskLevel === 'medium' ? 'secondary' : 'outline'
                    }
                  >
                    {riskLevel}
                  </Badge>
                )}
              </div>
            )}

            <Separator />

            {/* Officer identification */}
            <div className="flex items-center gap-2 text-sm">
              <User className="h-4 w-4 text-muted-foreground" />
              <span className="text-muted-foreground">Deciding Officer:</span>
              {hasOfficer ? (
                <span className="font-medium">{officerName || officerId}</span>
              ) : (
                <span className="text-red-500 text-xs">Officer identification required</span>
              )}
            </div>

            {/* Mandatory justification */}
            <div className="space-y-1.5">
              <label className="text-sm font-medium">
                Decision Justification <span className="text-red-500">*</span>
              </label>
              <textarea
                className="flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                placeholder="Document the reasoning for this compliance decision. This is required for FINTRAC record-keeping..."
                value={justification}
                onChange={(e) => setJustification(e.target.value)}
                disabled={loading || !canDecide}
              />
              <p className="text-xs text-muted-foreground">
                {justification.trim().length < 10
                  ? `${10 - justification.trim().length} more characters required (FINTRAC record-keeping)`
                  : 'Justification meets minimum requirements'}
              </p>
            </div>

            {/* Error display */}
            {error && (
              <div className="rounded-md bg-red-50 border border-red-200 px-3 py-2 text-sm text-red-700">
                {error}
              </div>
            )}

            <Separator />

            {/* Decision buttons — only enabled when officer is identified and justification provided */}
            <div className="space-y-2">
              <div className="grid grid-cols-3 gap-2">
                <Button
                  className="bg-green-600 hover:bg-green-700"
                  onClick={() => handleDecision('approved')}
                  disabled={!canSubmit}
                >
                  <CheckCircle className="h-4 w-4 mr-1.5" />
                  Approve
                </Button>
                <Button
                  variant="destructive"
                  onClick={() => handleDecision('denied')}
                  disabled={!canSubmit}
                >
                  <XCircle className="h-4 w-4 mr-1.5" />
                  Deny
                </Button>
                <Button
                  variant="outline"
                  className="border-amber-300 text-amber-700 hover:bg-amber-50"
                  onClick={() => handleDecision('escalated')}
                  disabled={!canSubmit}
                >
                  <AlertTriangle className="h-4 w-4 mr-1.5" />
                  Escalate
                </Button>
              </div>

              {!hasOfficer && (
                <p className="text-xs text-center text-red-500">
                  Buttons disabled: Officer identification required (REG-01)
                </p>
              )}
              {hasOfficer && !hasJustification && (
                <p className="text-xs text-center text-amber-600">
                  Buttons disabled: Written justification required (REG-04)
                </p>
              )}
              {canSubmit && (
                <p className="text-xs text-center text-muted-foreground">
                  Your decision will be permanently recorded in the compliance audit trail.
                </p>
              )}
            </div>

            {/* STR referral link */}
            {riskLevel && ['high', 'critical'].includes(riskLevel) && (
              <>
                <Separator />
                <Button
                  variant="ghost"
                  className="w-full text-amber-700 hover:text-amber-800 hover:bg-amber-50"
                  onClick={onSTRReferral}
                >
                  <AlertTriangle className="h-4 w-4 mr-2" />
                  Refer for STR Filing
                </Button>
              </>
            )}
          </CardContent>
        </Card>
      );
    }
    ```

    KEY DESIGN DECISIONS:
    1. **Buttons disabled by default** — Approve/Deny/Escalate are disabled until officer is identified AND justification is provided. The UI tells the officer WHY buttons are disabled with specific regulatory references (REG-01, REG-04).
    2. **AI recommendation is advisory** — Clearly labeled "Advisory Only" with REG-02 reference. Collapsible detail section. The officer's decision is independent of the AI's recommendation.
    3. **Justification is mandatory** — Character counter shows how many more characters needed. Placeholder text mentions FINTRAC record-keeping.
    4. **STR referral link** — Only appears for high/critical risk cases. Links to the STR workflow panel.
    5. **Success and decided states** — Clear confirmation that decision is recorded. Already-decided cases show read-only state.
    6. **Compliance badge** — FINTRAC compliance badge in the header.
    7. **Human-only indicator** — Clearly states that final compliance decision requires human officer authorization.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - decision-panel.tsx exports: DecisionPanel
    - Approve/Deny/Escalate buttons disabled when:
      - No officer_id (shows REG-01 message)
      - No justification or < 10 chars (shows REG-04 message)
      - Case not in decidable status
    - AI recommendation displayed as "Advisory Only" with REG-02 reference
    - Decision submits to POST /api/cases/{id}/decide
    - Success state confirms decision was recorded
    - STR referral button appears only for high/critical risk
    - Officer identification displayed
    - Justification character counter present
    - ComplianceBadge and HumanOnlyIndicator used in header
  </verify>
  <done>Decision panel built with full human-in-the-loop enforcement. Buttons disabled until officer identified and justification provided. AI recommendation clearly marked advisory. Regulatory references (REG-01, REG-02, REG-04) visible at enforcement points. STR referral link for high-risk cases.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for all new components
2. ComplianceBadge renders in 3 variants (default, compact, detailed)
3. RecordRetentionNotice displays 5-year PCMLTFA requirement
4. STRWorkflowPanel loads FINTRAC context and submits to /api/cases/{id}/str
5. STRWorkflowPanel requires officer_id and reason >= 20 chars before enabling submit
6. DecisionPanel requires officer_id and justification >= 10 chars before enabling buttons
7. AI recommendation labeled "Advisory Only" with REG-02 reference
8. Disabled buttons show specific regulatory requirement that's unmet
9. Success states confirm audit trail recording
10. All components use shadcn UI and lucide-react icons
</verification>

<success_criteria>
- FINTRAC compliance markers visible on dashboard (REG-04)
- STR filing workflow is clearly human-only with FINTRAC regulatory context displayed (REG-03)
- Decision panel enforces human-in-the-loop — buttons disabled without officer_id and justification (REG-01, REG-02)
- AI recommendation displayed as advisory only — clearly labeled (REG-02)
- Record-keeping notice (5+ year retention) visible on audit views (REG-04)
- Components are ready to embed in the case detail page from Phase 6/8
</success_criteria>

<output>
After completion, create `.planning/phases/09-regulatory-audit-trail/09-04-SUMMARY.md`
</output>
