---
phase: 04-sanctions-identity-screening
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/lib/sanctions/un-parser.ts
  - src/lib/sanctions/un-loader.ts
  - scripts/load-un-sanctions.ts
  - src/lib/sanctions/pep-data.ts
  - scripts/load-pep-database.ts
autonomous: true

must_haves:
  truths:
    - "UN Security Council sanctions list entries are stored in Supabase and queryable"
    - "PEP database contains realistic entries searchable by name"
    - "Both UN and PEP entries share the same schema as OFAC for unified querying"
  artifacts:
    - path: "src/lib/sanctions/un-parser.ts"
      provides: "UN consolidated sanctions list XML parser"
      exports: ["parseUnConsolidatedXml"]
    - path: "scripts/load-un-sanctions.ts"
      provides: "CLI script to download and load UN sanctions list"
    - path: "src/lib/sanctions/pep-data.ts"
      provides: "Mock PEP database with realistic entries"
      exports: ["PEP_ENTRIES"]
    - path: "scripts/load-pep-database.ts"
      provides: "CLI script to load PEP entries into Supabase"
  key_links:
    - from: "src/lib/sanctions/un-parser.ts"
      to: "src/lib/sanctions/types.ts"
      via: "imports SanctionsEntry type"
      pattern: "import.*SanctionsEntry.*from.*types"
    - from: "src/lib/sanctions/pep-data.ts"
      to: "src/lib/sanctions/types.ts"
      via: "PEP entries conform to SanctionsEntry type"
      pattern: "SanctionsEntry"
---

<objective>
Add UN Security Council sanctions list parsing/loading and a realistic mock PEP (Politically Exposed Persons) database. After this plan, all three sanctions data sources (OFAC, UN, PEP) are populated in Supabase.

Purpose: Complete sanctions data coverage requires multiple lists. UN sanctions cover different jurisdictions than OFAC. PEP screening is a separate but critical KYC requirement — identifying politically exposed persons who require enhanced due diligence.

Output: UN sanctions XML parser + loader, mock PEP database with ~50 realistic entries across multiple categories, both loaded into Supabase using the schema from Plan 01.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-sanctions-identity-screening/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build UN Security Council sanctions list parser and loader</name>
  <files>src/lib/sanctions/un-parser.ts, src/lib/sanctions/un-loader.ts, scripts/load-un-sanctions.ts</files>
  <action>
  **UN consolidated sanctions list XML format** (from https://scsanctions.un.org/resources/xml/en/consolidated.xml):
  Root: `<CONSOLIDATED_LIST>` with `dateGenerated` attribute.
  Contains `<INDIVIDUALS>` wrapper with `<INDIVIDUAL>` entries:
  - `<DATAID>` — unique numeric identifier
  - `<FIRST_NAME>` — first name
  - `<SECOND_NAME>` — last name / family name
  - `<THIRD_NAME>` — additional name parts (sometimes present)
  - `<UN_LIST_TYPE>` — sanctions regime (e.g., "DRC", "CAR", "ISIL")
  - `<REFERENCE_NUMBER>` — reference code
  - `<GENDER>` — gender
  - `<DESIGNATION>` — role/title
  - `<NATIONALITY><VALUE>` — nationality
  - `<LIST_TYPE>` — always "UN List"
  - `<INDIVIDUAL_DATE_OF_BIRTH>` with `<TYPE_OF_DATE>` (EXACT, APPROXIMATELY, BETWEEN) and `<DATE>` or `<YEAR>`
  - `<INDIVIDUAL_ALIAS>` with `<QUALITY>` (Good, Low, a.k.a.) and `<ALIAS_NAME>`
  - `<COMMENTS1>` — additional context
  Also contains `<ENTITIES>` wrapper with `<ENTITY>` entries (similar structure but for organizations).

  Create `src/lib/sanctions/un-parser.ts`:
  - Use `fast-xml-parser` (already added in Plan 01)
  - Export `parseUnConsolidatedXml(xmlContent: string): { entries: SanctionsEntry[], aliases: SanctionsAlias[] }`
  - Parse both `<INDIVIDUALS>` and `<ENTITIES>` sections
  - Map to unified SanctionsEntry with source='UN_SECURITY_COUNCIL'
  - Combine FIRST_NAME + SECOND_NAME + THIRD_NAME into primary_name
  - Map UN_LIST_TYPE to programs array
  - Parse DOB — handle EXACT (direct date), APPROXIMATELY (store in remarks), BETWEEN (store range in remarks)
  - Extract all INDIVIDUAL_ALIAS entries as SanctionsAlias with quality mapped from UN quality field
  - Set source_url to `https://scsanctions.un.org/`

  Handle UN XML quirks:
  - INDIVIDUAL_ALIAS may be single object or array — normalize to array
  - THIRD_NAME may be absent
  - INDIVIDUAL_DATE_OF_BIRTH may have only YEAR, not full DATE
  - Some entries have NATIONALITY as object, others as array — normalize
  - ENTITY entries don't have FIRST_NAME/SECOND_NAME — use `<FIRST_NAME>` from entity (which is actually the full name)

  Create `src/lib/sanctions/un-loader.ts`:
  - Reuse same pattern as ofac-loader.ts
  - Export `loadUnEntries(entries, aliases)` — batch upsert into Supabase

  Create `scripts/load-un-sanctions.ts`:
  - Download from `https://scsanctions.un.org/resources/xml/en/consolidated.xml`
  - Note: This URL redirects to `https://unsolprodfiles.blob.core.windows.net/publiclegacyxmlfiles/EN/consolidatedLegacyByPRN.xml` — follow redirects
  - Parse and load using un-parser and un-loader
  - Print summary
  </action>
  <verify>
  - `npx tsc --noEmit src/lib/sanctions/un-parser.ts` compiles
  - `npx tsx scripts/load-un-sanctions.ts` downloads, parses, and loads UN data
  - `SELECT count(*) FROM sanctions_entries WHERE source = 'UN_SECURITY_COUNCIL'` returns > 0 (UN list has ~700+ individuals + entities)
  - `SELECT * FROM sanctions_entries WHERE source = 'UN_SECURITY_COUNCIL' LIMIT 3` shows properly formatted entries
  </verify>
  <done>UN Security Council consolidated sanctions list downloaded, parsed, and loaded into Supabase alongside OFAC data in unified schema.</done>
</task>

<task type="auto">
  <name>Task 2: Create mock PEP database and loader</name>
  <files>src/lib/sanctions/pep-data.ts, scripts/load-pep-database.ts</files>
  <action>
  Create `src/lib/sanctions/pep-data.ts` with a hardcoded array of ~50 realistic PEP entries.

  **PEP categories** (use these as programs[] values):
  - `PEP_HEAD_OF_STATE` — current or former heads of state/government
  - `PEP_SENIOR_POLITICIAN` — senior political figures
  - `PEP_SENIOR_MILITARY` — senior military officials
  - `PEP_JUDICIARY` — senior judicial officials
  - `PEP_SENIOR_EXECUTIVE` — senior executives of state-owned enterprises
  - `PEP_INTL_ORG` — senior officials of international organizations
  - `PEP_FAMILY_MEMBER` — close family members of PEPs
  - `PEP_CLOSE_ASSOCIATE` — known close associates of PEPs

  Create ~50 entries across these categories. Use REALISTIC but FICTIONAL names. Do NOT use real politicians' names. Mix of:
  - 10 head of state / senior politician entries (various nationalities: Canadian, American, British, French, German, Saudi, Chinese, Indian, Brazilian, Nigerian)
  - 8 senior military entries
  - 7 judiciary entries
  - 5 senior executives of state-owned enterprises
  - 5 international organization officials
  - 8 family member entries (with remarks linking to the primary PEP)
  - 7 close associate entries (with remarks linking to the primary PEP)

  Each entry should be a valid SanctionsEntry with:
  - source: 'PEP'
  - source_id: 'PEP-001' through 'PEP-050'
  - entry_type: 'individual'
  - Realistic first/last names reflecting the nationality
  - date_of_birth where available
  - nationality set
  - programs: array of PEP category
  - remarks: describing the role (e.g., "Former Minister of Finance, fictional country of Westland")

  Include 2-3 entries with Arabic names to test fuzzy matching integration:
  - e.g., "Ahmad Al-Rashid" (PEP_SENIOR_POLITICIAN, nationality Saudi Arabia)
  - e.g., "Mohammed bin Khalid Al-Faisal" (PEP_FAMILY_MEMBER)

  Export as `PEP_ENTRIES: SanctionsEntry[]` and `PEP_ALIASES: SanctionsAlias[]` (a few entries should have known aliases).

  Create `scripts/load-pep-database.ts`:
  - Import PEP_ENTRIES and PEP_ALIASES from pep-data.ts
  - Load into Supabase sanctions_entries with source='PEP'
  - Upsert logic (re-runnable)
  - Print summary
  </action>
  <verify>
  - `npx tsc --noEmit src/lib/sanctions/pep-data.ts` compiles
  - PEP_ENTRIES array has ~50 entries across all 8 categories
  - `npx tsx scripts/load-pep-database.ts` loads entries into Supabase
  - `SELECT count(*) FROM sanctions_entries WHERE source = 'PEP'` returns ~50
  - `SELECT programs, count(*) FROM sanctions_entries WHERE source = 'PEP' GROUP BY programs` shows distribution across categories
  </verify>
  <done>Mock PEP database with ~50 realistic entries across 8 categories loaded into Supabase. Includes Arabic name variants for fuzzy matching testing.</done>
</task>

</tasks>

<verification>
- `SELECT source, count(*) FROM sanctions_entries GROUP BY source` shows entries for all three sources: OFAC_SDN, UN_SECURITY_COUNCIL, PEP
- All three loader scripts are re-runnable without creating duplicates
- UN entries have properly parsed aliases and DOB information
- PEP entries span all 8 categories with realistic data
</verification>

<success_criteria>
- UN Security Council sanctions list fully loaded and searchable
- PEP database populated with ~50 categorized entries
- All three data sources (OFAC, UN, PEP) queryable through the same sanctions_entries table
- Scripts are idempotent — safe to re-run
</success_criteria>

<output>
After completion, create `.planning/phases/04-sanctions-identity-screening/04-03-SUMMARY.md`
</output>
