---
phase: 04-sanctions-identity-screening
plan: 05
type: execute
wave: 3
depends_on: ["04-03", "04-04"]
files_modified:
  - src/agents/sanctions-screener/index.ts
  - src/agents/sanctions-screener/tools.ts
  - src/agents/sanctions-screener/prompt.ts
autonomous: true

must_haves:
  truths:
    - "Sanctions Screener agent accepts identity data and returns structured screening results"
    - "Agent screens against OFAC, UN, and PEP lists in a single invocation"
    - "Agent returns match/no-match with confidence, evidence links, and list source"
    - "Agent integrates into the orchestration pipeline from Phase 2"
  artifacts:
    - path: "src/agents/sanctions-screener/index.ts"
      provides: "Sanctions Screener agent definition using Google GenAI SDK"
      exports: ["sanctionsScreenerAgent", "SanctionsScreenerInput", "SanctionsScreenerOutput"]
    - path: "src/agents/sanctions-screener/tools.ts"
      provides: "Tools the Sanctions Screener agent can use"
      exports: ["sanctionsScreenerTools"]
    - path: "src/agents/sanctions-screener/prompt.ts"
      provides: "System prompt for the Sanctions Screener agent"
      exports: ["SANCTIONS_SCREENER_PROMPT"]
  key_links:
    - from: "src/agents/sanctions-screener/tools.ts"
      to: "src/lib/sanctions/screening-service.ts"
      via: "tools call screenIdentity"
      pattern: "import.*screenIdentity.*from.*screening-service"
    - from: "src/agents/sanctions-screener/index.ts"
      to: "src/agents/sanctions-screener/tools.ts"
      via: "agent configured with screening tools"
      pattern: "tools.*sanctionsScreenerTools"
---

<objective>
Create the Sanctions Screener agent using Google GenAI SDK. This agent receives identity data (name, DOB, nationality) from the orchestrator, screens against all sanctions lists, and returns structured results with confidence scoring and evidence.

Purpose: This is requirement ORCH-04 — a specialized agent in the multi-agent KYC pipeline. It wraps the screening service in a Gemini agent that can reason about results, explain findings, and integrate with the orchestration framework from Phase 2.

Output: Google GenAI SDK agent with tools for sanctions screening, system prompt for compliance reasoning, and structured input/output types.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-sanctions-identity-screening/04-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define Sanctions Screener agent tools and system prompt</name>
  <files>src/agents/sanctions-screener/tools.ts, src/agents/sanctions-screener/prompt.ts</files>
  <action>
  Check the existing agent structure from Phase 2. Look at:
  - `src/agents/` directory for established patterns (how other agents are defined)
  - Phase 2 orchestrator code to understand the agent interface contract
  - Any base agent utilities or shared types

  Follow whatever pattern Phase 2 established. If no agents exist yet, follow Google GenAI SDK conventions.

  Create `src/agents/sanctions-screener/tools.ts`:

  Define tools the agent can call:

  **screen_identity** tool:
  - Description: "Screen a person's identity against OFAC SDN, UN Security Council, and PEP sanctions lists"
  - Input schema: `{ fullName: string, dateOfBirth?: string, nationality?: string }`
  - Implementation: calls `screenIdentity()` from screening-service.ts
  - Returns: full ScreeningResult object

  **screen_name_only** tool:
  - Description: "Quick name-only screen against sanctions lists (when DOB/nationality not available)"
  - Input schema: `{ name: string, sources?: ('OFAC_SDN' | 'UN_SECURITY_COUNCIL' | 'PEP')[] }`
  - Implementation: calls `screenName()` from screening-service.ts
  - Returns: ScreeningResult

  **get_entry_details** tool:
  - Description: "Get full details of a specific sanctions list entry by ID"
  - Input schema: `{ entryId: string }`
  - Implementation: Supabase query to get full sanctions_entries row + aliases
  - Returns: full SanctionsEntry with aliases

  Create `src/agents/sanctions-screener/prompt.ts`:

  ```typescript
  export const SANCTIONS_SCREENER_PROMPT = `You are a Sanctions Screening Agent in a KYC/AML compliance system.

  Your role: Screen individuals against OFAC SDN, UN Security Council, and PEP (Politically Exposed Persons) sanctions lists.

  PROCESS:
  1. Receive identity data (name, optionally DOB and nationality)
  2. Screen against all three sanctions lists using the screen_identity tool
  3. Analyze the results — consider confidence scores, match types, and evidence
  4. Return a structured assessment

  IMPORTANT RULES:
  - ALWAYS screen against ALL three lists unless specifically instructed otherwise
  - Report ALL matches, even low-confidence ones — let the human officer decide
  - Never dismiss a potential match — false negatives are worse than false positives in sanctions screening
  - Include the source list and evidence link for every match
  - If a name has common variations (e.g., Mohammed/Muhammad), note this in your assessment
  - Confidence interpretation:
    - High (>0.85): Strong match — likely the same person, requires immediate attention
    - Medium (0.6-0.85): Potential match — could be the same person, needs manual review
    - Low (<0.6): Weak match — probably coincidental similarity, include for completeness

  OUTPUT FORMAT:
  Return a JSON object with:
  {
    "status": "clear" | "flagged",
    "risk_level": "clear" | "potential_match" | "strong_match",
    "total_matches": number,
    "matches": [
      {
        "list_source": "OFAC_SDN" | "UN_SECURITY_COUNCIL" | "PEP",
        "matched_name": "name on the list",
        "match_confidence": "high" | "medium" | "low",
        "match_score": number,
        "match_type": "exact" | "fuzzy" | "phonetic" | "alias",
        "entry_details": {
          "programs": ["..."],
          "nationality": "...",
          "date_of_birth": "...",
          "designation": "..."
        },
        "evidence_url": "url to source list"
      }
    ],
    "screening_summary": "Human-readable summary of findings",
    "recommendations": ["List of recommended actions"],
    "screened_at": "ISO timestamp"
  }`;
  ```
  </action>
  <verify>
  - `npx tsc --noEmit src/agents/sanctions-screener/tools.ts` compiles
  - `npx tsc --noEmit src/agents/sanctions-screener/prompt.ts` compiles
  - Tools correctly import and call screening-service functions
  - Tool input schemas match ScreeningRequest type
  </verify>
  <done>Sanctions Screener agent tools wrap the screening service, and system prompt defines compliance-aware reasoning behavior.</done>
</task>

<task type="auto">
  <name>Task 2: Create Sanctions Screener agent definition and test invocation</name>
  <files>src/agents/sanctions-screener/index.ts</files>
  <action>
  Check the existing agent pattern from Phase 2 first. Look at:
  - How other agents are defined (if any exist in src/agents/)
  - The orchestrator's agent registration/invocation pattern
  - Any shared agent base types

  Create `src/agents/sanctions-screener/index.ts`:

  Follow the Phase 2 agent pattern. If using Google GenAI SDK:
  ```typescript
  import { GoogleGenerativeAI } from "@google/generative-ai";
  ```

  Define input/output types:
  ```typescript
  export interface SanctionsScreenerInput {
    fullName: string;
    dateOfBirth?: string;
    nationality?: string;
    documentNumber?: string;
    caseId: string;           // links to the KYC case
  }

  export interface SanctionsScreenerOutput {
    status: 'clear' | 'flagged';
    risk_level: 'clear' | 'potential_match' | 'strong_match';
    total_matches: number;
    matches: Array<{
      list_source: string;
      matched_name: string;
      match_confidence: 'high' | 'medium' | 'low';
      match_score: number;
      match_type: string;
      entry_details: {
        programs: string[];
        nationality: string | null;
        date_of_birth: string | null;
        designation: string | null;
      };
      evidence_url: string | null;
    }>;
    screening_summary: string;
    recommendations: string[];
    screened_at: string;
  }
  ```

  Create the agent function:
  - Use Gemini 2.5 Pro (model: "gemini-2.5-pro" or whatever model ID the project uses)
  - Configure with SANCTIONS_SCREENER_PROMPT as system prompt
  - Register sanctionsScreenerTools
  - Accept SanctionsScreenerInput, produce SanctionsScreenerOutput
  - The agent should:
    1. Call screen_identity tool with the input data
    2. Analyze results using Gemini's reasoning
    3. Return structured SanctionsScreenerOutput

  Export the agent so the orchestrator can invoke it:
  ```typescript
  export async function runSanctionsScreener(input: SanctionsScreenerInput): Promise<SanctionsScreenerOutput>
  ```

  Add a simple smoke test at the bottom (or in a separate test file):
  - Can be run with `npx tsx src/agents/sanctions-screener/index.ts` with a test invocation
  - Screen a clearly fake name ("John Everyman Test") — should return clear
  - Screen a name known to be in the PEP mock database — should return flagged

  Match whatever agent pattern Phase 2 established. The key is that the orchestrator can call `runSanctionsScreener(input)` and get back a typed result.
  </action>
  <verify>
  - `npx tsc --noEmit src/agents/sanctions-screener/index.ts` compiles
  - Agent exports runSanctionsScreener function
  - Quick smoke test: `npx tsx -e "import {runSanctionsScreener} from './src/agents/sanctions-screener'; console.log(typeof runSanctionsScreener)"` prints "function"
  - If API key available, test invocation with a fake name returns 'clear' status
  </verify>
  <done>Sanctions Screener agent is a callable function that accepts identity data, screens against all lists via Gemini reasoning, and returns structured results compatible with the orchestration pipeline.</done>
</task>

</tasks>

<verification>
- Agent can be imported and called from the orchestrator
- Screening a clean name returns status: 'clear' with 0 matches
- Screening a name matching a PEP entry returns status: 'flagged' with match details
- Agent output includes all required fields: status, risk_level, matches, screening_summary, recommendations
- TypeScript compiles without errors for all agent files
</verification>

<success_criteria>
- Sanctions Screener agent is a single callable function in the orchestration pipeline
- Agent screens against OFAC, UN, and PEP lists in one invocation
- Returns structured, typed results with confidence scoring
- Gemini reasoning provides human-readable screening summary and recommendations
- Follows Phase 2 agent patterns for orchestrator compatibility
</success_criteria>

<output>
After completion, create `.planning/phases/04-sanctions-identity-screening/04-05-SUMMARY.md`
</output>
