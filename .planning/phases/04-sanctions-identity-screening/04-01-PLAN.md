---
phase: 04-sanctions-identity-screening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/004_sanctions_schema.sql
  - src/lib/sanctions/types.ts
  - src/lib/sanctions/ofac-parser.ts
  - src/lib/sanctions/ofac-loader.ts
  - scripts/load-ofac-sdn.ts
autonomous: true

must_haves:
  truths:
    - "OFAC SDN list entries are stored in Supabase and queryable by name"
    - "Sanctions database schema supports both OFAC and UN list entries in a unified format"
    - "OFAC aliases (AKAs) are stored and searchable alongside primary names"
  artifacts:
    - path: "supabase/migrations/004_sanctions_schema.sql"
      provides: "Sanctions database tables — unified schema for all sanctions lists"
      contains: "CREATE TABLE sanctions_entries"
    - path: "src/lib/sanctions/types.ts"
      provides: "TypeScript types for sanctions data"
      exports: ["SanctionsEntry", "SanctionsAlias", "SanctionsListSource", "SanctionsSearchResult"]
    - path: "src/lib/sanctions/ofac-parser.ts"
      provides: "OFAC SDN XML parser"
      exports: ["parseOfacSdnXml"]
    - path: "src/lib/sanctions/ofac-loader.ts"
      provides: "OFAC data loader into Supabase"
      exports: ["loadOfacEntries"]
    - path: "scripts/load-ofac-sdn.ts"
      provides: "CLI script to download and load OFAC SDN list"
  key_links:
    - from: "src/lib/sanctions/ofac-parser.ts"
      to: "src/lib/sanctions/types.ts"
      via: "imports SanctionsEntry type"
      pattern: "import.*SanctionsEntry.*from.*types"
    - from: "src/lib/sanctions/ofac-loader.ts"
      to: "supabase"
      via: "inserts parsed entries into sanctions_entries table"
      pattern: "supabase.*from.*sanctions_entries.*insert"
---

<objective>
Create the sanctions data foundation: Supabase schema for storing sanctions list entries from multiple sources (OFAC, UN, PEP) in a unified format, plus the OFAC SDN list XML parser and data loader.

Purpose: All downstream sanctions screening depends on having searchable, normalized sanctions data in the database. The unified schema ensures OFAC, UN, and PEP entries can all be queried through the same interface.

Output: Supabase migration for sanctions tables, TypeScript types, OFAC SDN XML parser, and a CLI loader script that downloads and imports the full OFAC SDN list.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sanctions database schema and TypeScript types</name>
  <files>supabase/migrations/004_sanctions_schema.sql, src/lib/sanctions/types.ts</files>
  <action>
  Create Supabase migration `004_sanctions_schema.sql` with these tables:

  **sanctions_entries** table:
  - `id` UUID primary key (gen_random_uuid())
  - `source` TEXT NOT NULL — enum-like: 'OFAC_SDN', 'UN_SECURITY_COUNCIL', 'PEP'
  - `source_id` TEXT — original ID from the source list (e.g., OFAC UID, UN DATAID)
  - `entry_type` TEXT NOT NULL — 'individual' or 'entity'
  - `primary_name` TEXT NOT NULL — full name as listed (last_name + first_name for OFAC, combined for UN)
  - `first_name` TEXT — parsed first name
  - `last_name` TEXT — parsed last name
  - `date_of_birth` DATE — nullable, not all entries have DOB
  - `nationality` TEXT — nullable
  - `programs` TEXT[] — array of program codes (e.g., ['SDGT', 'IRAN'])
  - `remarks` TEXT — additional info, comments
  - `source_url` TEXT — link back to the original listing
  - `raw_data` JSONB — full original entry for reference
  - `created_at` TIMESTAMPTZ DEFAULT now()
  - `updated_at` TIMESTAMPTZ DEFAULT now()

  **sanctions_aliases** table:
  - `id` UUID primary key (gen_random_uuid())
  - `entry_id` UUID NOT NULL REFERENCES sanctions_entries(id) ON DELETE CASCADE
  - `alias_name` TEXT NOT NULL — the alternative name
  - `alias_type` TEXT — 'aka', 'fka', 'nka' (also known as, formerly, now known as)
  - `alias_quality` TEXT — 'good', 'low' (UN uses quality ratings)

  Add indexes:
  - `idx_sanctions_entries_source` on (source)
  - `idx_sanctions_entries_primary_name` using GIN with pg_trgm on (primary_name) for trigram fuzzy search
  - `idx_sanctions_entries_entry_type` on (entry_type)
  - `idx_sanctions_aliases_alias_name` using GIN with pg_trgm on (alias_name) for trigram fuzzy search
  - `idx_sanctions_aliases_entry_id` on (entry_id)

  Enable pg_trgm extension at top of migration: `CREATE EXTENSION IF NOT EXISTS pg_trgm;`

  Create TypeScript types in `src/lib/sanctions/types.ts`:
  ```typescript
  export type SanctionsListSource = 'OFAC_SDN' | 'UN_SECURITY_COUNCIL' | 'PEP';
  export type SanctionsEntryType = 'individual' | 'entity';

  export interface SanctionsEntry {
    id: string;
    source: SanctionsListSource;
    source_id: string | null;
    entry_type: SanctionsEntryType;
    primary_name: string;
    first_name: string | null;
    last_name: string | null;
    date_of_birth: string | null;
    nationality: string | null;
    programs: string[];
    remarks: string | null;
    source_url: string | null;
    raw_data: Record<string, unknown>;
    created_at: string;
    updated_at: string;
    aliases?: SanctionsAlias[];
  }

  export interface SanctionsAlias {
    id: string;
    entry_id: string;
    alias_name: string;
    alias_type: string | null;
    alias_quality: string | null;
  }

  export type MatchConfidence = 'high' | 'medium' | 'low';

  export interface SanctionsSearchResult {
    entry: SanctionsEntry;
    match_type: 'exact' | 'fuzzy' | 'phonetic' | 'alias';
    confidence: MatchConfidence;
    score: number; // 0-1 similarity score
    matched_field: string; // which field matched (primary_name, alias, etc.)
    matched_value: string; // the value that matched
  }
  ```
  </action>
  <verify>
  - Migration file exists and contains valid SQL with CREATE TABLE, indexes, and pg_trgm extension
  - Types file exports all required types: SanctionsEntry, SanctionsAlias, SanctionsListSource, SanctionsSearchResult, MatchConfidence
  - `npx tsc --noEmit src/lib/sanctions/types.ts` compiles without errors
  </verify>
  <done>Supabase sanctions schema ready for all three list sources (OFAC, UN, PEP) with trigram indexes for fuzzy search. TypeScript types exported and type-safe.</done>
</task>

<task type="auto">
  <name>Task 2: Build OFAC SDN XML parser and loader script</name>
  <files>src/lib/sanctions/ofac-parser.ts, src/lib/sanctions/ofac-loader.ts, scripts/load-ofac-sdn.ts</files>
  <action>
  **OFAC SDN XML format** (from https://www.treasury.gov/ofac/downloads/sdn.xml):
  The XML has a root `<sdnList>` element containing `<sdnEntry>` elements. Each entry has:
  - `<uid>` — unique identifier
  - `<lastName>` — primary last name
  - `<firstName>` — first name (may be empty for entities)
  - `<sdnType>` — "Individual" or "Entity"
  - `<programList><program>` — sanctioning programs
  - `<akaList><aka>` — aliases with `<type>` (a.k.a., f.k.a., n.k.a.), `<lastName>`, `<firstName>`
  - `<dateOfBirthList><dateOfBirthItem><dateOfBirth>` — DOB entries
  - `<nationalityList><nationality><country>` — nationalities
  - `<remarks>` — additional notes

  Create `src/lib/sanctions/ofac-parser.ts`:
  - Use `fast-xml-parser` (add to package.json) to parse the XML
  - Export `parseOfacSdnXml(xmlContent: string): { entries: SanctionsEntry[], aliases: SanctionsAlias[] }`
  - Map `<sdnEntry>` to `SanctionsEntry` with source='OFAC_SDN'
  - Combine lastName + firstName into primary_name
  - Extract all `<aka>` entries as `SanctionsAlias` records
  - Map aka type: "a.k.a." -> "aka", "f.k.a." -> "fka", "n.k.a." -> "nka"
  - Parse DOB into ISO date format where possible (OFAC uses various formats)
  - Set source_url to `https://sanctionslist.ofac.treas.gov/` for all entries
  - Store full original entry in raw_data as JSON

  Handle OFAC XML quirks:
  - Some entries have no firstName (entities)
  - DOB can be approximate ("circa 1965") — store as-is in remarks if not parseable
  - akaList may be absent or have single entry (not array) — normalize to array
  - programList may have single program — normalize to array

  Create `src/lib/sanctions/ofac-loader.ts`:
  - Export `loadOfacEntries(entries: SanctionsEntry[], aliases: SanctionsAlias[]): Promise<{ entriesLoaded: number, aliasesLoaded: number }>`
  - Use Supabase client to upsert entries into sanctions_entries (upsert on source + source_id)
  - Batch insert in chunks of 500 to avoid payload limits
  - After entries loaded, insert aliases with correct entry_id foreign keys
  - Log progress during loading (every 500 entries)

  Create `scripts/load-ofac-sdn.ts`:
  - CLI script runnable with `npx tsx scripts/load-ofac-sdn.ts`
  - Downloads OFAC SDN XML from `https://www.treasury.gov/ofac/downloads/sdn.xml` using fetch
  - Follows redirects (the URL redirects to an S3 bucket)
  - Parses XML using parseOfacSdnXml
  - Loads into Supabase using loadOfacEntries
  - Prints summary: total entries, total aliases, time elapsed
  - Add error handling for network failures and parse errors
  </action>
  <verify>
  - `npx tsc --noEmit src/lib/sanctions/ofac-parser.ts` compiles
  - `npx tsc --noEmit src/lib/sanctions/ofac-loader.ts` compiles
  - `npx tsc --noEmit scripts/load-ofac-sdn.ts` compiles
  - Parser correctly handles sample OFAC XML (create a small test fixture with 2-3 entries)
  - Running `npx tsx scripts/load-ofac-sdn.ts` downloads, parses, and loads data (verify with Supabase query showing entry count > 0)
  </verify>
  <done>OFAC SDN list downloaded, parsed from XML, and loaded into Supabase sanctions_entries table with all aliases. Script is re-runnable (upsert logic).</done>
</task>

</tasks>

<verification>
- `SELECT count(*) FROM sanctions_entries WHERE source = 'OFAC_SDN'` returns > 0 (OFAC has ~11,000+ entries)
- `SELECT count(*) FROM sanctions_aliases WHERE entry_id IN (SELECT id FROM sanctions_entries WHERE source = 'OFAC_SDN')` returns > 0
- `SELECT * FROM sanctions_entries WHERE primary_name ILIKE '%bin laden%' LIMIT 5` returns results
- TypeScript types compile cleanly
</verification>

<success_criteria>
- OFAC SDN list is fully loaded into Supabase with searchable names and aliases
- Database schema supports OFAC, UN, and PEP entries through unified structure
- Trigram indexes enable fuzzy text search on names
- Loader script is idempotent and re-runnable
</success_criteria>

<output>
After completion, create `.planning/phases/04-sanctions-identity-screening/04-01-SUMMARY.md`
</output>
