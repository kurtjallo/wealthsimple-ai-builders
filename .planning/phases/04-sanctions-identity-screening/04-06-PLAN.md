---
phase: 04-sanctions-identity-screening
plan: 06
type: execute
wave: 3
depends_on: ["04-02", "04-04"]
files_modified:
  - src/agents/identity-verifier/index.ts
  - src/agents/identity-verifier/tools.ts
  - src/agents/identity-verifier/prompt.ts
autonomous: true

must_haves:
  truths:
    - "Identity Verifier agent cross-references extracted identity data against verification sources"
    - "Agent detects inconsistencies in name, DOB, nationality, and document data"
    - "Agent produces a confidence-scored identity verification report"
    - "Agent integrates into the orchestration pipeline from Phase 2"
  artifacts:
    - path: "src/agents/identity-verifier/index.ts"
      provides: "Identity Verifier agent definition using Google GenAI SDK"
      exports: ["runIdentityVerifier", "IdentityVerifierInput", "IdentityVerifierOutput"]
    - path: "src/agents/identity-verifier/tools.ts"
      provides: "Tools the Identity Verifier agent can use"
      exports: ["identityVerifierTools"]
    - path: "src/agents/identity-verifier/prompt.ts"
      provides: "System prompt for the Identity Verifier agent"
      exports: ["IDENTITY_VERIFIER_PROMPT"]
  key_links:
    - from: "src/agents/identity-verifier/tools.ts"
      to: "src/lib/sanctions/screening-service.ts"
      via: "uses screenName for watchlist cross-reference"
      pattern: "import.*screenName.*from.*screening-service"
    - from: "src/agents/identity-verifier/index.ts"
      to: "src/agents/identity-verifier/tools.ts"
      via: "agent configured with verification tools"
      pattern: "tools.*identityVerifierTools"
---

<objective>
Create the Identity Verifier agent using Google GenAI SDK. This agent receives extracted identity data (from the Document Processor agent in Phase 3) and cross-references it against verification sources — checking for internal consistency, name format validity, DOB plausibility, and watchlist presence.

Purpose: This is requirement ORCH-03 — the agent that verifies whether extracted identity data is internally consistent and cross-references it against external sources. Unlike the Sanctions Screener (which specifically screens against sanctions lists), the Identity Verifier performs broader identity verification: Are the documents consistent? Is the name format valid? Does the DOB make sense? Are there any watchlist flags?

Output: Google GenAI SDK agent with verification tools, compliance-aware prompt, and structured input/output types.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-sanctions-identity-screening/04-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define Identity Verifier agent tools and system prompt</name>
  <files>src/agents/identity-verifier/tools.ts, src/agents/identity-verifier/prompt.ts</files>
  <action>
  Check existing agent patterns from Phase 2 and the Sanctions Screener (Plan 05) for consistency.

  Create `src/agents/identity-verifier/tools.ts`:

  **verify_name_consistency** tool:
  - Description: "Check if name data from multiple documents is consistent"
  - Input: `{ names: Array<{ source: string, fullName: string, firstName?: string, lastName?: string }> }`
  - Implementation: Use fuzzyMatchName from fuzzy-match.ts to compare names across sources
  - Returns: `{ consistent: boolean, confidence: number, discrepancies: string[] }`
  - Example: passport says "John A. Smith", utility bill says "John Smith" — consistent (minor variation). Passport says "John Smith", bank statement says "Jane Doe" — inconsistent.

  **verify_dob_plausibility** tool:
  - Description: "Check if date of birth is plausible and consistent across documents"
  - Input: `{ dateOfBirth: string, documentDates?: Array<{ source: string, date: string }> }`
  - Implementation:
    - Check age is between 18-120 (KYC accounts must be adults)
    - Check DOB is not in the future
    - If multiple DOB sources, check they match
  - Returns: `{ plausible: boolean, age: number, issues: string[] }`

  **verify_document_validity** tool:
  - Description: "Check basic document validity indicators"
  - Input: `{ documentType: string, documentNumber: string, expiryDate?: string, issuingCountry?: string }`
  - Implementation:
    - Check document is not expired (if expiry date provided)
    - Check document number format matches expected pattern for document type:
      - Passport: typically 8-9 alphanumeric chars
      - Driver's license: varies by country/state
      - National ID: varies by country
    - This is heuristic validation, not authoritative
  - Returns: `{ valid: boolean, issues: string[], confidence: number }`

  **cross_reference_watchlists** tool:
  - Description: "Cross-reference identity against sanctions and PEP watchlists"
  - Input: `{ fullName: string, dateOfBirth?: string, nationality?: string }`
  - Implementation: calls `screenIdentity()` from screening-service.ts
  - Returns: ScreeningResult (reuses sanctions screening)

  Create `src/agents/identity-verifier/prompt.ts`:

  ```typescript
  export const IDENTITY_VERIFIER_PROMPT = `You are an Identity Verification Agent in a KYC/AML compliance system.

  Your role: Verify the identity of individuals by cross-referencing extracted document data, checking for internal consistency, and flagging potential issues.

  VERIFICATION PROCESS:
  1. Receive extracted identity data from document processing (names, DOB, addresses, document numbers from one or more documents)
  2. Check NAME CONSISTENCY across documents — do all documents refer to the same person?
  3. Check DOB PLAUSIBILITY — is the person a legal adult? Is DOB consistent across sources?
  4. Check DOCUMENT VALIDITY — are documents not expired? Do document numbers match expected formats?
  5. Cross-reference against WATCHLISTS — is this person on any sanctions or PEP lists?
  6. Produce an overall identity verification assessment

  VERIFICATION RULES:
  - Minor name variations are normal (middle name present/absent, initials vs full names)
  - Major name discrepancies between documents are red flags
  - Expired documents are not automatically disqualifying but must be flagged
  - Watchlist matches require human review — never auto-clear or auto-deny
  - When in doubt, flag for manual review — err on the side of caution

  CONFIDENCE SCORING:
  - Each verification check produces a confidence score (0-1)
  - Overall confidence = weighted average:
    - Name consistency: 30%
    - DOB plausibility: 20%
    - Document validity: 20%
    - Watchlist clear: 30%

  OUTPUT FORMAT:
  Return a JSON object with:
  {
    "verification_status": "verified" | "flagged" | "failed",
    "overall_confidence": number (0-1),
    "checks": {
      "name_consistency": {
        "status": "pass" | "warning" | "fail",
        "confidence": number,
        "details": "description"
      },
      "dob_plausibility": {
        "status": "pass" | "warning" | "fail",
        "confidence": number,
        "details": "description"
      },
      "document_validity": {
        "status": "pass" | "warning" | "fail",
        "confidence": number,
        "details": "description"
      },
      "watchlist_screening": {
        "status": "clear" | "flagged",
        "confidence": number,
        "details": "description",
        "matches": []
      }
    },
    "risk_factors": ["list of identified risk factors"],
    "recommendations": ["list of recommended actions"],
    "verification_summary": "Human-readable summary"
  }`;
  ```
  </action>
  <verify>
  - `npx tsc --noEmit src/agents/identity-verifier/tools.ts` compiles
  - `npx tsc --noEmit src/agents/identity-verifier/prompt.ts` compiles
  - All four tools correctly import their dependencies
  - Tool schemas are well-defined with clear input/output types
  </verify>
  <done>Identity Verifier tools cover name consistency, DOB plausibility, document validity, and watchlist cross-reference. System prompt defines verification reasoning workflow.</done>
</task>

<task type="auto">
  <name>Task 2: Create Identity Verifier agent definition</name>
  <files>src/agents/identity-verifier/index.ts</files>
  <action>
  Follow the same agent pattern established in the Sanctions Screener (Plan 05) and Phase 2.

  Create `src/agents/identity-verifier/index.ts`:

  Define input/output types:
  ```typescript
  export interface IdentityVerifierInput {
    caseId: string;
    // Extracted identity data (from Document Processor agent in Phase 3)
    extractedData: {
      fullName: string;
      firstName?: string;
      lastName?: string;
      dateOfBirth?: string;
      nationality?: string;
      address?: string;
      documentType?: string;
      documentNumber?: string;
      documentExpiry?: string;
      issuingCountry?: string;
    };
    // Optional: data from multiple documents for cross-referencing
    additionalDocuments?: Array<{
      source: string;  // "passport", "utility_bill", "bank_statement"
      extractedData: {
        fullName?: string;
        firstName?: string;
        lastName?: string;
        dateOfBirth?: string;
        address?: string;
        documentNumber?: string;
      };
    }>;
  }

  export interface IdentityVerifierOutput {
    verification_status: 'verified' | 'flagged' | 'failed';
    overall_confidence: number;
    checks: {
      name_consistency: {
        status: 'pass' | 'warning' | 'fail';
        confidence: number;
        details: string;
      };
      dob_plausibility: {
        status: 'pass' | 'warning' | 'fail';
        confidence: number;
        details: string;
      };
      document_validity: {
        status: 'pass' | 'warning' | 'fail';
        confidence: number;
        details: string;
      };
      watchlist_screening: {
        status: 'clear' | 'flagged';
        confidence: number;
        details: string;
        matches: Array<{
          list_source: string;
          matched_name: string;
          match_confidence: string;
          match_score: number;
        }>;
      };
    };
    risk_factors: string[];
    recommendations: string[];
    verification_summary: string;
  }
  ```

  Create the agent function:
  ```typescript
  export async function runIdentityVerifier(input: IdentityVerifierInput): Promise<IdentityVerifierOutput>
  ```

  Implementation:
  - Use Gemini 2.5 Pro (same model as Sanctions Screener)
  - Configure with IDENTITY_VERIFIER_PROMPT as system prompt
  - Register identityVerifierTools
  - Pass extracted data in the user message
  - Agent uses tools to perform each verification check
  - Parse Gemini's structured output into IdentityVerifierOutput

  The agent message should include the extracted data formatted clearly:
  ```
  Verify the following identity:

  Primary Document:
  - Name: {fullName}
  - DOB: {dateOfBirth}
  - Nationality: {nationality}
  - Document: {documentType} #{documentNumber}, expires {documentExpiry}

  Additional Documents:
  {for each additional document, list source and extracted data}

  Perform all verification checks and return your assessment.
  ```

  Match the Phase 2 orchestrator pattern so this agent can be invoked alongside other agents (Document Processor, Sanctions Screener) in parallel.
  </action>
  <verify>
  - `npx tsc --noEmit src/agents/identity-verifier/index.ts` compiles
  - runIdentityVerifier is exported
  - Input/output types are compatible with orchestrator expectations
  - Quick type check: `npx tsx -e "import {runIdentityVerifier} from './src/agents/identity-verifier'; console.log(typeof runIdentityVerifier)"` prints "function"
  </verify>
  <done>Identity Verifier agent is callable from the orchestrator, performs 4 verification checks (name, DOB, document, watchlist), and returns a structured confidence-scored verification report.</done>
</task>

</tasks>

<verification>
- Agent can be imported and called: `import { runIdentityVerifier } from 'src/agents/identity-verifier'`
- Agent output includes all required fields: verification_status, overall_confidence, checks, risk_factors, recommendations
- Watchlist screening check uses the screening service from Plan 04
- Agent follows the same pattern as Sanctions Screener for orchestrator compatibility
- TypeScript compiles without errors
</verification>

<success_criteria>
- Identity Verifier agent performs comprehensive identity verification
- Four verification checks: name consistency, DOB plausibility, document validity, watchlist screening
- Structured output with confidence scores for each check and overall
- Compatible with Phase 2 orchestration pipeline
- Handles single-document and multi-document verification scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/04-sanctions-identity-screening/04-06-SUMMARY.md`
</output>
