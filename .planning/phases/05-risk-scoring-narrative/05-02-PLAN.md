---
phase: 05-risk-scoring-narrative
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/agents/risk-scorer/index.ts
  - src/agents/risk-scorer/scoring-engine.ts
  - src/agents/risk-scorer/tool.ts
autonomous: true

must_haves:
  truths:
    - "Risk Scorer agent accepts signals from Document Processor, Identity Verifier, Sanctions Screener, and PEP Screener"
    - "Composite risk score calculated using weighted formula: doc 20%, identity 25%, sanctions 35%, PEP 20%"
    - "Risk categorized as Low (0-25), Medium (26-50), High (51-75), Critical (76-100)"
    - "Confidence level derived from individual agent confidence scores"
    - "Critical risk (76-100) triggers auto-escalation flag with reason"
  artifacts:
    - path: "src/agents/risk-scorer/scoring-engine.ts"
      provides: "Pure scoring logic with weighted aggregation"
      exports: ["calculateCompositeRisk", "calculateComponentScore", "calculateConfidence"]
    - path: "src/agents/risk-scorer/tool.ts"
      provides: "Claude Agent SDK tool definition for risk scoring"
      exports: ["riskScorerTool"]
    - path: "src/agents/risk-scorer/index.ts"
      provides: "Risk Scorer agent definition using Claude Agent SDK"
      exports: ["riskScorerAgent", "runRiskScorer"]
  key_links:
    - from: "src/agents/risk-scorer/scoring-engine.ts"
      to: "src/types/risk.ts"
      via: "imports signal types and returns RiskScore"
      pattern: "import.*from.*types/risk"
    - from: "src/agents/risk-scorer/index.ts"
      to: "src/agents/risk-scorer/scoring-engine.ts"
      via: "agent calls scoring engine to compute results"
      pattern: "import.*calculateCompositeRisk.*from.*scoring-engine"
    - from: "src/agents/risk-scorer/tool.ts"
      to: "src/agents/risk-scorer/scoring-engine.ts"
      via: "tool handler invokes scoring engine"
      pattern: "calculateCompositeRisk"
---

<objective>
Build the Risk Scorer agent that aggregates signals from all upstream agents into a composite risk score with confidence levels and auto-escalation.

Purpose: ORCH-05 — the Risk Scorer is the quantitative backbone of the system. It transforms qualitative agent outputs (document validity, identity match, sanctions hit) into a single numeric score that drives the compliance officer's workflow. Critical risk auto-escalates to senior officers.

Output: A working Risk Scorer agent with pure scoring logic separated from the Claude Agent SDK integration, ready to be wired into the orchestration pipeline (Plan 04).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-risk-scoring-narrative/05-01-SUMMARY.md
@src/types/risk.ts
@src/types/narrative.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement the scoring engine (pure logic)</name>
  <files>src/agents/risk-scorer/scoring-engine.ts</files>
  <action>
Create `src/agents/risk-scorer/scoring-engine.ts` — a pure TypeScript module with NO Claude SDK or LLM dependencies. This is deterministic scoring logic.

**Function 1: `calculateDocumentRiskScore(signal: DocumentSignal): number`**
Returns 0-100 risk score for document verification:
- Start at 0 (no risk)
- documentValidity === 'invalid' → +60
- documentValidity === 'uncertain' → +30
- extractionConfidence < 0.5 → +20
- extractionConfidence < 0.8 → +10
- fieldsMissing.length > 3 → +15
- fieldsMissing.length > 0 → +5
- ocrQuality < 0.5 → +10
- Cap at 100

**Function 2: `calculateIdentityRiskScore(signal: IdentitySignal): number`**
Returns 0-100 risk score:
- verificationStatus === 'failed' → +70
- verificationStatus === 'unverified' → +50
- verificationStatus === 'partial' → +25
- matchConfidence < 0.5 → +20
- matchConfidence < 0.8 → +10
- discrepancies.length * 15 (each discrepancy adds risk)
- Cap at 100

**Function 3: `calculateSanctionsRiskScore(signal: SanctionsSignal): number`**
Returns 0-100 risk score — highest impact:
- matchStatus === 'confirmed_match' → 100 (immediate critical)
- matchStatus === 'potential_match':
  - Any exact match → 90
  - Any fuzzy match with score > 0.85 → 75
  - Any fuzzy match with score > 0.7 → 60
  - Otherwise → 45
- matchStatus === 'clear' → 0

**Function 4: `calculatePEPRiskScore(signal: PEPSignal): number`**
Returns 0-100 risk score:
- pepStatus === 'confirmed_pep':
  - head_of_state/senior_politician → 85
  - military_leader/judicial → 70
  - senior_executive → 55
  - family_member/close_associate → 45
- pepStatus === 'potential_pep' → 35
- pepStatus === 'clear' → 0

**Function 5: `calculateConfidence(signals): ConfidenceLevel`**
Compute overall confidence from individual signal confidences:
- documentConfidence = signal.document.extractionConfidence
- identityConfidence = signal.identity.matchConfidence
- sanctionsConfidence: 'confirmed_match' → 0.95, 'potential_match' → max fuzzyScore, 'clear' → 0.90
- pepConfidence = signal.pep.confidence
- overall = weighted average using same weights as risk (doc 20%, identity 25%, sanctions 35%, PEP 20%)

**Function 6: `calculateCompositeRisk(signals, weights?): RiskScore`**
Main aggregation function:
- Calculate each component score using functions above
- Apply weights (use DEFAULT_RISK_WEIGHTS if not provided)
- compositeScore = round(doc * w.doc + identity * w.identity + sanctions * w.sanctions + pep * w.pep)
- category = getRiskCategory(compositeScore)
- autoEscalate = category === 'critical'
- escalationReason: if auto-escalate, include which component(s) triggered it (e.g., "Sanctions confirmed match", "Composite score 82/100")
- Return complete RiskScore object

All functions must be pure (no side effects, no async, no external calls). Import types from `@/types/risk` (or relative path depending on project tsconfig paths).
  </action>
  <verify>
1. Write a quick inline test or use the TypeScript compiler to verify:
   - `calculateCompositeRisk` with all-clear signals returns score 0, category 'low'
   - `calculateCompositeRisk` with confirmed sanctions match returns category 'critical', autoEscalate true
   - Weights sum to 1.0
   - All component functions return values in 0-100 range
2. `npx tsc --noEmit src/agents/risk-scorer/scoring-engine.ts`
  </verify>
  <done>Pure scoring engine with 6 functions: 4 component scorers (doc, identity, sanctions, PEP), confidence calculator, and composite aggregator. All deterministic, all typed, no LLM dependency. Sanctions confirmed match → 100 (critical). All-clear → 0 (low). Auto-escalation triggers on critical (76+).</done>
</task>

<task type="auto">
  <name>Task 2: Create Risk Scorer agent with Claude Agent SDK</name>
  <files>src/agents/risk-scorer/tool.ts, src/agents/risk-scorer/index.ts</files>
  <action>
**Part A: Create `src/agents/risk-scorer/tool.ts`**

Define a Claude Agent SDK tool that the Risk Scorer agent uses to compute risk scores. The tool wraps the pure scoring engine.

```typescript
// Tool definition for Claude Agent SDK
// Name: "calculate_risk_score"
// Description: "Calculate composite risk score from agent signals. Takes document, identity, sanctions, and PEP signals as input and returns a weighted risk score with confidence levels."
// Input schema: { document: DocumentSignal, identity: IdentitySignal, sanctions: SanctionsSignal, pep: PEPSignal, weights?: RiskWeight }
// Handler: calls calculateCompositeRisk from scoring-engine.ts and returns RiskScore
```

Follow the Claude Agent SDK tool pattern established in Phase 2. The tool should:
1. Accept the four agent signals as a single input object
2. Call `calculateCompositeRisk` from scoring-engine.ts
3. Return the complete RiskScore object
4. Handle any validation errors (missing signals, invalid data) gracefully

**Part B: Create `src/agents/risk-scorer/index.ts`**

Define the Risk Scorer agent using Claude Agent SDK:

```typescript
// Agent configuration:
// - name: "Risk Scorer"
// - model: "claude-sonnet-4-6" (reasoning for score interpretation)
// - tools: [riskScorerTool]
// - system prompt: See below

// System prompt for the agent:
`You are the Risk Scorer agent in a KYC/AML compliance system. Your job is to:

1. Receive signals from four upstream agents:
   - Document Processor: extraction confidence, document validity
   - Identity Verifier: verification status, match confidence
   - Sanctions Screener: match/no-match, list source, fuzzy match score
   - PEP Screener: PEP status, category, confidence

2. Use the calculate_risk_score tool to compute the composite risk score.

3. Analyze the results and provide a brief interpretation:
   - Which factors contributed most to the score
   - Whether auto-escalation was triggered and why
   - Any notable patterns or concerns

You MUST use the calculate_risk_score tool — do not attempt to calculate scores manually.
Return the RiskScore object along with your interpretation.`
```

Export:
- `riskScorerAgent` — the agent definition/configuration
- `runRiskScorer(signals: { document, identity, sanctions, pep }): Promise<RiskAssessment>` — a convenience function that:
  1. Creates/invokes the agent with the signals
  2. Extracts the RiskScore from the agent's tool use
  3. Constructs and returns a complete RiskAssessment object with id (uuid), caseId, score, signals, assessedAt (ISO timestamp), assessedBy

Follow the agent creation patterns established in Phase 2 (orchestration core). Check `.planning/phases/02-agent-orchestration-core/` for SUMMARY or source code to match patterns.
  </action>
  <verify>
1. `npx tsc --noEmit src/agents/risk-scorer/index.ts` — compiles without errors
2. Verify the agent exports match expected interface:
   - `riskScorerAgent` is a valid Claude Agent SDK agent config
   - `runRiskScorer` accepts signals object and returns Promise<RiskAssessment>
3. Tool definition has proper input schema matching the signal types
  </verify>
  <done>Risk Scorer agent defined with Claude Agent SDK, uses calculate_risk_score tool backed by pure scoring engine. Agent provides LLM interpretation of scores. Convenience function `runRiskScorer` provides clean API for orchestrator integration.</done>
</task>

</tasks>

<verification>
1. All three files compile without TypeScript errors
2. Scoring engine correctly implements the weighted formula: doc(20%) + identity(25%) + sanctions(35%) + PEP(20%)
3. Risk categories correctly assigned: Low 0-25, Medium 26-50, High 51-75, Critical 76-100
4. Auto-escalation triggers on critical scores (76+)
5. Agent follows Claude Agent SDK patterns from Phase 2
6. Clean separation: scoring-engine.ts is pure logic, tool.ts is SDK integration, index.ts is agent definition
</verification>

<success_criteria>
- Scoring engine produces deterministic results for all signal combinations
- Confirmed sanctions match always results in critical risk (score 100)
- All-clear signals produce low risk (score near 0)
- Agent can be invoked via `runRiskScorer()` and returns complete RiskAssessment
- No direct LLM calls in scoring logic — LLM only interprets results
</success_criteria>

<output>
After completion, create `.planning/phases/05-risk-scoring-narrative/05-02-SUMMARY.md`
</output>
