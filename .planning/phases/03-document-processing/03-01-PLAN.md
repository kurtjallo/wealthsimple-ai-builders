---
phase: 03-document-processing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/documents.ts
  - src/lib/ocr/mistral-client.ts
  - src/lib/ocr/types.ts
autonomous: true

must_haves:
  truths:
    - "Mistral OCR client can process a document URL and return raw markdown text"
    - "Document processing types cover all four document types (passport, drivers_license, utility_bill, corporate_doc)"
    - "Extracted data types include per-field confidence scores"
  artifacts:
    - path: "src/types/documents.ts"
      provides: "Complete type definitions for document processing pipeline"
      contains: "PassportData"
    - path: "src/lib/ocr/mistral-client.ts"
      provides: "Mistral OCR API client wrapper"
      contains: "processDocument"
    - path: "src/lib/ocr/types.ts"
      provides: "OCR-specific types for Mistral API responses"
      contains: "OcrPage"
  key_links:
    - from: "src/lib/ocr/mistral-client.ts"
      to: "@mistralai/mistralai"
      via: "SDK import"
      pattern: "import.*Mistral.*mistralai"
    - from: "src/lib/ocr/mistral-client.ts"
      to: "src/lib/ocr/types.ts"
      via: "type imports"
      pattern: "import.*types"
---

<objective>
Define all TypeScript types for the document processing pipeline and build the Mistral OCR client wrapper that extracts raw text from document images/PDFs.

Purpose: Establish the type foundation and OCR integration that all other document processing plans build on. Without types and OCR, nothing else in Phase 3 can work.
Output: Type definitions for all document types (passport, license, utility bill, corporate doc) with per-field confidence scores, plus a working Mistral OCR client that processes documents and returns structured markdown.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define document processing types with per-field confidence</name>
  <files>src/types/documents.ts, src/lib/ocr/types.ts</files>
  <action>
    1. Create `src/types/documents.ts` with complete type definitions for the document processing pipeline:

    ```typescript
    // Re-export DocumentType from index.ts
    import { DocumentType } from './index';

    // A single extracted field with its confidence score
    export interface ExtractedField<T = string> {
      value: T;
      confidence: number; // 0.0 to 1.0
      source: string; // which part of the OCR text this came from
    }

    // Passport extracted data
    export interface PassportData {
      full_name: ExtractedField;
      date_of_birth: ExtractedField;
      nationality: ExtractedField;
      passport_number: ExtractedField;
      expiry_date: ExtractedField;
      gender: ExtractedField;
      issuing_country: ExtractedField;
      mrz_line1?: ExtractedField; // Machine Readable Zone
      mrz_line2?: ExtractedField;
    }

    // Driver's license extracted data
    export interface DriversLicenseData {
      full_name: ExtractedField;
      date_of_birth: ExtractedField;
      address: ExtractedField;
      license_number: ExtractedField;
      expiry_date: ExtractedField;
      class: ExtractedField;
      issuing_province_state: ExtractedField;
    }

    // Utility bill extracted data
    export interface UtilityBillData {
      account_holder_name: ExtractedField;
      service_address: ExtractedField;
      account_number: ExtractedField;
      bill_date: ExtractedField;
      utility_provider: ExtractedField;
    }

    // Corporate registration document extracted data
    export interface CorporateDocData {
      company_name: ExtractedField;
      registration_number: ExtractedField;
      incorporation_date: ExtractedField;
      registered_address: ExtractedField;
      directors: ExtractedField<string[]>;
      jurisdiction: ExtractedField;
      company_type: ExtractedField;
    }

    // Union type for all extracted data
    export type ExtractedDocumentData =
      | { type: 'passport'; data: PassportData }
      | { type: 'drivers_license'; data: DriversLicenseData }
      | { type: 'utility_bill'; data: UtilityBillData }
      | { type: 'corporate_doc'; data: CorporateDocData };

    // Overall document processing result
    export interface DocumentProcessingResult {
      document_id: string;
      document_type: DocumentType;
      ocr_raw_text: string;
      extracted: ExtractedDocumentData;
      overall_confidence: number; // average of all field confidences
      processing_time_ms: number;
      warnings: string[]; // e.g., "Low image quality", "Partial text extraction"
    }
    ```

    2. Create `src/lib/ocr/types.ts` with Mistral OCR API response types:

    ```typescript
    // Mistral OCR API response types (based on API docs)
    export interface OcrPage {
      index: number;
      markdown: string;
      images: OcrImage[];
      dimensions: {
        dpi: number;
        height: number;
        width: number;
      };
    }

    export interface OcrImage {
      id: string;
      top_left_x: number;
      top_left_y: number;
      bottom_right_x: number;
      bottom_right_y: number;
      image_base64?: string;
    }

    export interface OcrResponse {
      pages: OcrPage[];
      model: string;
      usage_info: Record<string, unknown>;
    }

    // Input types for our OCR wrapper
    export interface OcrDocumentInput {
      type: 'url' | 'base64';
      content: string; // URL string or base64-encoded document
      mime_type?: string; // e.g., 'image/jpeg', 'application/pdf'
    }
    ```

    IMPORTANT: Do NOT add `directors` as `ExtractedField<string>` — it must be `ExtractedField<string[]>` since a company can have multiple directors. The generic on ExtractedField defaults to `string` but allows override.
  </action>
  <verify>
    - `npx tsc --noEmit` passes — all types compile correctly
    - `src/types/documents.ts` exports: ExtractedField, PassportData, DriversLicenseData, UtilityBillData, CorporateDocData, ExtractedDocumentData, DocumentProcessingResult
    - `src/lib/ocr/types.ts` exports: OcrPage, OcrResponse, OcrDocumentInput
    - ExtractedField has value, confidence, and source properties
  </verify>
  <done>
    All document processing types defined with per-field confidence scoring. Types cover passport, driver's license, utility bill, and corporate registration documents.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Mistral OCR client wrapper</name>
  <files>src/lib/ocr/mistral-client.ts</files>
  <action>
    1. Install the Mistral SDK if not already present:
    ```bash
    npm install @mistralai/mistralai
    ```

    2. Create `src/lib/ocr/mistral-client.ts` — a wrapper around the Mistral OCR API:

    ```typescript
    import { Mistral } from '@mistralai/mistralai';
    import { OcrResponse, OcrDocumentInput } from './types';

    const MODEL = 'mistral-ocr-latest';

    function getMistralClient(): Mistral {
      const apiKey = process.env.MISTRAL_API_KEY;
      if (!apiKey) {
        throw new Error('MISTRAL_API_KEY environment variable is not set');
      }
      return new Mistral({ apiKey });
    }

    /**
     * Process a document through Mistral OCR.
     * Accepts either a URL to the document or a base64-encoded document.
     * Returns the raw OCR response with page-level markdown text.
     */
    export async function processDocument(input: OcrDocumentInput): Promise<OcrResponse> {
      const client = getMistralClient();

      const document = input.type === 'url'
        ? { type: 'document_url' as const, documentUrl: input.content }
        : { type: 'image_url' as const, imageUrl: `data:${input.mime_type || 'image/jpeg'};base64,${input.content}` };

      const response = await client.ocr.process({
        model: MODEL,
        document,
      });

      return response as unknown as OcrResponse;
    }

    /**
     * Extract concatenated text from all pages of an OCR response.
     * Joins page markdown with double newlines.
     */
    export function extractFullText(response: OcrResponse): string {
      return response.pages
        .map((page) => page.markdown)
        .join('\n\n');
    }

    /**
     * Process a document and return the full extracted text.
     * Convenience function combining processDocument + extractFullText.
     */
    export async function ocrExtractText(input: OcrDocumentInput): Promise<{
      raw_text: string;
      page_count: number;
      model: string;
    }> {
      const response = await processDocument(input);
      return {
        raw_text: extractFullText(response),
        page_count: response.pages.length,
        model: response.model,
      };
    }
    ```

    IMPORTANT NOTES:
    - The Mistral TypeScript SDK uses camelCase for properties (e.g., `documentUrl` not `document_url`), but the API response may use snake_case. Check SDK types and cast as needed.
    - If the SDK's `client.ocr.process` method signature doesn't match exactly, adapt to the actual SDK interface. The SDK may use different property names than the REST API docs.
    - Create the client per-request (not singleton) because Next.js API routes are serverless.
    - For base64 input, the Mistral vision API accepts data URIs in the `image_url` field.
  </action>
  <verify>
    - `npx tsc --noEmit` passes — Mistral client compiles
    - `src/lib/ocr/mistral-client.ts` exports: processDocument, extractFullText, ocrExtractText
    - The file imports from `@mistralai/mistralai` correctly
    - No hardcoded API keys — uses process.env.MISTRAL_API_KEY
  </verify>
  <done>
    Mistral OCR client wrapper built with processDocument (raw OCR), extractFullText (text extraction), and ocrExtractText (convenience) functions. Client handles both URL and base64 document inputs.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no type errors
2. All document types exported from src/types/documents.ts
3. Mistral client compiles and imports SDK correctly
4. No hardcoded secrets in any file
5. ExtractedField generic supports both string and string[] (for directors)
</verification>

<success_criteria>
- Complete type system for document processing with per-field confidence (DOC-04 types)
- Mistral OCR client can process document URLs and base64 inputs (DOC-01 foundation)
- Types cover all four document categories: passport, driver's license, utility bill, corporate doc
- All code compiles with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-document-processing/03-01-SUMMARY.md`
</output>
