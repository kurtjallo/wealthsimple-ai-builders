---
phase: 03-document-processing
plan: 06
type: execute
wave: 4
depends_on: ["03-05"]
files_modified:
  - scripts/test-document-processing.ts
  - test-documents/README.md
autonomous: true

must_haves:
  truths:
    - "A test script exercises the full document processing pipeline end-to-end"
    - "Test script validates OCR output, structured extraction, and confidence scores"
    - "Sample document sources are documented for manual testing"
  artifacts:
    - path: "scripts/test-document-processing.ts"
      provides: "End-to-end test script for document processing pipeline"
      contains: "documentProcessorAgent"
    - path: "test-documents/README.md"
      provides: "Documentation of sample documents for testing"
      contains: "passport"
  key_links:
    - from: "scripts/test-document-processing.ts"
      to: "src/lib/agents/document-processor.ts"
      via: "direct agent invocation"
      pattern: "import.*documentProcessorAgent"
    - from: "scripts/test-document-processing.ts"
      to: "src/lib/ocr/mistral-client.ts"
      via: "direct OCR call for testing"
      pattern: "import.*ocrExtractText"
---

<objective>
Create an end-to-end test script that validates the entire document processing pipeline, and document the test data setup for manual verification.

Purpose: Before the pipeline integrates with the orchestrator and dashboard, we need to verify that OCR, extraction, and confidence scoring work correctly end-to-end. This script exercises the pipeline with real or sample documents and validates the output.
Output: A runnable test script and test document setup instructions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-document-processing/03-04-SUMMARY.md
@.planning/phases/03-document-processing/03-05-SUMMARY.md
@src/lib/agents/document-processor.ts
@src/lib/ocr/mistral-client.ts
@src/lib/ocr/structured-extractor.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create end-to-end test script for document processing</name>
  <files>scripts/test-document-processing.ts, test-documents/README.md</files>
  <action>
    1. Create `scripts/test-document-processing.ts` — an executable test script that validates the pipeline:

    ```typescript
    /**
     * End-to-end test for the document processing pipeline.
     *
     * Usage:
     *   npx tsx scripts/test-document-processing.ts
     *
     * Requires:
     *   - MISTRAL_API_KEY in .env.local
     *   - GEMINI_API_KEY in .env.local
     *
     * This script tests:
     *   1. Mistral OCR text extraction (from a public document URL)
     *   2. Gemini structured data extraction with confidence scoring
     *   3. Full agent pipeline (OCR -> extraction -> result)
     *
     * Note: Database operations are skipped (no Supabase required for this test).
     */

    import * as dotenv from 'dotenv';
    import path from 'path';

    // Load environment variables
    dotenv.config({ path: path.resolve(process.cwd(), '.env.local') });

    import { ocrExtractText } from '../src/lib/ocr/mistral-client';
    import { extractStructuredData } from '../src/lib/ocr/structured-extractor';
    import { DocumentType } from '../src/types/index';

    // Sample public document URLs for testing
    // These are publicly accessible sample documents
    const TEST_DOCUMENTS: { url: string; type: DocumentType; description: string }[] = [
      {
        // A sample passport-like document (use a public test image)
        url: 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5a/Microformat-hcard-full-example.png/440px-Microformat-hcard-full-example.png',
        type: 'passport',
        description: 'Sample ID card image (testing OCR + passport extraction on ID-like document)',
      },
    ];

    async function testOcrExtraction() {
      console.log('\n=== TEST 1: Mistral OCR Text Extraction ===\n');

      for (const doc of TEST_DOCUMENTS) {
        console.log(`Processing: ${doc.description}`);
        console.log(`URL: ${doc.url}`);
        console.log(`Type: ${doc.type}`);

        try {
          const startTime = Date.now();
          const result = await ocrExtractText({ type: 'url', content: doc.url });
          const duration = Date.now() - startTime;

          console.log(`\nOCR Result:`);
          console.log(`  Pages: ${result.page_count}`);
          console.log(`  Text length: ${result.raw_text.length} chars`);
          console.log(`  Model: ${result.model}`);
          console.log(`  Duration: ${duration}ms`);
          console.log(`  First 500 chars:\n${result.raw_text.substring(0, 500)}`);
          console.log('\n  [PASS] OCR extraction completed successfully');

          return result.raw_text; // Return for next test
        } catch (error) {
          console.error(`  [FAIL] OCR extraction failed:`, error);
          return null;
        }
      }
    }

    async function testStructuredExtraction(ocrText: string) {
      console.log('\n=== TEST 2: Gemini Structured Data Extraction ===\n');

      // Test with passport type
      const docType: DocumentType = 'passport';
      console.log(`Extracting structured data as: ${docType}`);

      try {
        const startTime = Date.now();
        const result = await extractStructuredData(ocrText, docType);
        const duration = Date.now() - startTime;

        console.log(`\nExtraction Result:`);
        console.log(`  Document type: ${result.extracted.type}`);
        console.log(`  Overall confidence: ${result.overall_confidence}`);
        console.log(`  Warnings: ${result.warnings.length > 0 ? result.warnings.join(', ') : 'none'}`);
        console.log(`  Duration: ${duration}ms`);

        console.log(`\n  Extracted Fields:`);
        const data = result.extracted.data as Record<string, { value: unknown; confidence: number; source: string }>;
        for (const [key, field] of Object.entries(data)) {
          if (field && typeof field === 'object' && 'confidence' in field) {
            const confBar = '█'.repeat(Math.round(field.confidence * 10)) + '░'.repeat(10 - Math.round(field.confidence * 10));
            console.log(`    ${key}: "${field.value}" [${confBar}] ${(field.confidence * 100).toFixed(0)}%`);
          }
        }

        console.log('\n  [PASS] Structured extraction completed successfully');
        return result;
      } catch (error) {
        console.error(`  [FAIL] Structured extraction failed:`, error);
        return null;
      }
    }

    async function testWithMockOcrText() {
      console.log('\n=== TEST 3: Structured Extraction with Mock OCR Text ===\n');

      // Test with realistic mock OCR output for each document type
      const mockTexts: { type: DocumentType; text: string }[] = [
        {
          type: 'passport',
          text: `CANADA
PASSPORT / PASSEPORT
Type/Type P
Country Code/Code du pays CAN
Surname/Nom SMITH
Given Names/Prénoms JOHN ROBERT
Nationality/Nationalité CANADIAN / CANADIENNE
Date of birth/Date de naissance 15 MAR 1985
Sex/Sexe M
Place of birth/Lieu de naissance TORONTO, ON
Date of issue/Date de délivrance 20 JUN 2020
Date of expiry/Date d'expiration 20 JUN 2030
Authority/Autorité PASSPORT CANADA
Passport No./No de passeport GA123456

P<CANSMITH<<JOHN<ROBERT<<<<<<<<<<<<<<<<<<<
GA12345678CAN8503151M3006207<<<<<<<<<<<<<<02`,
        },
        {
          type: 'utility_bill',
          text: `Toronto Hydro
Statement Date: January 15, 2025
Account Number: 7890-1234-5678

John R. Smith
123 Main Street, Unit 4B
Toronto, ON M5V 2K1

Service Address:
123 Main Street, Unit 4B
Toronto, ON M5V 2K1

Billing Period: Dec 15, 2024 - Jan 14, 2025
Amount Due: $127.45
Due Date: February 5, 2025`,
        },
        {
          type: 'corporate_doc',
          text: `CERTIFICATE OF INCORPORATION
Business Corporations Act

Corporation Name: ACME Technologies Inc.
Corporation Number: BC1234567
Date of Incorporation: March 15, 2020
Jurisdiction: British Columbia, Canada

Registered Office:
456 Business Park Drive, Suite 200
Vancouver, BC V6B 4N2

Directors:
1. John Robert Smith - Director
2. Sarah Jane Williams - Director
3. Michael David Chen - Director

Type of Corporation: Private Corporation (BC)`,
        },
      ];

      for (const mock of mockTexts) {
        console.log(`\nTesting ${mock.type} extraction with mock text...`);

        try {
          const startTime = Date.now();
          const result = await extractStructuredData(mock.text, mock.type);
          const duration = Date.now() - startTime;

          console.log(`  Type: ${result.extracted.type}`);
          console.log(`  Confidence: ${(result.overall_confidence * 100).toFixed(0)}%`);
          console.log(`  Warnings: ${result.warnings.length > 0 ? result.warnings.join(', ') : 'none'}`);
          console.log(`  Duration: ${duration}ms`);

          // Validate confidence is reasonable for clean mock text
          if (result.overall_confidence >= 0.7) {
            console.log(`  [PASS] High confidence extraction (${(result.overall_confidence * 100).toFixed(0)}%)`);
          } else if (result.overall_confidence >= 0.3) {
            console.log(`  [WARN] Medium confidence extraction (${(result.overall_confidence * 100).toFixed(0)}%)`);
          } else {
            console.log(`  [FAIL] Low confidence extraction (${(result.overall_confidence * 100).toFixed(0)}%)`);
          }

          // Print extracted fields
          const data = result.extracted.data as Record<string, { value: unknown; confidence: number }>;
          for (const [key, field] of Object.entries(data)) {
            if (field && typeof field === 'object' && 'confidence' in field) {
              console.log(`    ${key}: "${field.value}" (${(field.confidence * 100).toFixed(0)}%)`);
            }
          }
        } catch (error) {
          console.error(`  [FAIL] ${mock.type} extraction failed:`, error);
        }
      }
    }

    async function main() {
      console.log('========================================');
      console.log('  Document Processing Pipeline Test');
      console.log('========================================');

      // Check environment variables
      if (!process.env.MISTRAL_API_KEY) {
        console.error('\n[ERROR] MISTRAL_API_KEY not set. Set it in .env.local');
        process.exit(1);
      }
      if (!process.env.GEMINI_API_KEY) {
        console.error('\n[ERROR] GEMINI_API_KEY not set. Set it in .env.local');
        process.exit(1);
      }

      console.log('\nEnvironment: OK (API keys found)');

      // Test 1: OCR extraction from real URL
      const ocrText = await testOcrExtraction();

      // Test 2: Structured extraction from real OCR output
      if (ocrText) {
        await testStructuredExtraction(ocrText);
      }

      // Test 3: Structured extraction from mock OCR text (always runs)
      await testWithMockOcrText();

      console.log('\n========================================');
      console.log('  Test Suite Complete');
      console.log('========================================\n');
    }

    main().catch(console.error);
    ```

    2. Add `dotenv` as a dev dependency if not already present:
    ```bash
    npm install -D dotenv tsx
    ```

    3. Create `test-documents/README.md` with instructions for obtaining test documents:

    ```markdown
    # Test Documents

    This directory is for storing sample documents used to test the document processing pipeline.

    ## How to Test

    Run the automated test script:
    ```bash
    npx tsx scripts/test-document-processing.ts
    ```

    This script tests:
    1. Mistral OCR text extraction from a public image URL
    2. Gemini structured extraction on real OCR output
    3. Gemini structured extraction on mock OCR text (passport, utility bill, corporate doc)

    ## Sample Documents for Manual Testing

    For manual testing through the API, you can use:

    ### Passport
    - Use any sample passport image (search "sample passport image" - use clearly marked specimens)
    - The system extracts: name, DOB, nationality, passport number, expiry, gender, issuing country, MRZ lines

    ### Driver's License
    - Use sample driver's license images
    - The system extracts: name, DOB, address, license number, expiry, class, issuing province/state

    ### Utility Bill
    - Screenshot or PDF of any utility bill
    - The system extracts: account holder name, service address, account number, bill date, utility provider

    ### Corporate Registration
    - Certificate of incorporation or business registration
    - The system extracts: company name, registration number, incorporation date, address, directors, jurisdiction, company type

    ## File Formats

    Supported: JPEG, PNG, WebP, PDF
    Max size: 10MB

    ## Important

    Do NOT commit real personal documents to this repository.
    All test documents should be clearly marked as specimens/samples.
    ```

    IMPORTANT: The test script uses `dotenv` to load .env.local and `tsx` to run TypeScript directly. Install both as dev dependencies. The mock OCR text tests always run (no API key needed for Gemini extraction test, but GEMINI_API_KEY is needed). The real OCR test requires MISTRAL_API_KEY.
  </action>
  <verify>
    - `npx tsc --noEmit` passes (the script may need tsconfig path adjustments — use relative imports if @ paths don't resolve)
    - `scripts/test-document-processing.ts` exists and is executable with `npx tsx`
    - `test-documents/README.md` exists with testing instructions
    - Script checks for required API keys before running
    - Script tests OCR extraction, structured extraction, and mock text extraction
    - Script outputs clear PASS/WARN/FAIL indicators
  </verify>
  <done>
    End-to-end test script created that validates the complete document processing pipeline: OCR extraction from URLs, structured data extraction with confidence scoring for passport/utility bill/corporate doc types, and mock text extraction. Test documents directory documented with setup instructions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add npm script and verify full pipeline compiles</name>
  <files>package.json</files>
  <action>
    1. Add a convenience npm script for running the document processing test:

    Add to the "scripts" section of `package.json`:
    ```json
    "test:documents": "tsx scripts/test-document-processing.ts"
    ```

    2. Run `npx tsc --noEmit` to verify the entire document processing pipeline compiles without errors. Fix any type errors.

    3. If there are import path issues in the test script (@ alias may not resolve in tsx), switch to relative imports:
    - `../src/lib/ocr/mistral-client` instead of `@/lib/ocr/mistral-client`
    - `../src/lib/ocr/structured-extractor` instead of `@/lib/ocr/structured-extractor`
    - etc.

    4. Verify the full file tree for Phase 3:
    ```
    src/
      types/
        documents.ts          # Document processing types (Plan 01)
      lib/
        ocr/
          types.ts            # OCR API types (Plan 01)
          mistral-client.ts   # Mistral OCR wrapper (Plan 01)
          extraction-prompts.ts  # Document-specific prompts (Plan 03)
          structured-extractor.ts  # Gemini extraction (Plan 03)
        supabase/
          client.ts           # Supabase client (Plan 02)
          storage.ts          # File upload/download (Plan 02)
          documents.ts        # Document CRUD (Plan 02)
        agents/
          types.ts            # Agent interface (Plan 04)
          document-processor.ts  # Document Processor agent (Plan 04)
      app/
        api/
          documents/
            upload/route.ts   # Upload endpoint (Plan 05)
            process/route.ts  # Process endpoint (Plan 05)
            [id]/route.ts     # Retrieval endpoint (Plan 05)
    scripts/
      test-document-processing.ts  # E2E test (Plan 06)
    supabase/
      migrations/
        003_documents_storage.sql  # DB migration (Plan 02)
    test-documents/
      README.md              # Test docs guide (Plan 06)
    ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes with zero errors
    - `npm run test:documents` is a valid script in package.json
    - All files from Phase 3 plans exist at the expected paths
    - No circular import issues
  </verify>
  <done>
    Full Phase 3 pipeline compiles and test script is runnable via `npm run test:documents`. All document processing artifacts verified.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes — entire Phase 3 codebase compiles
2. `npm run test:documents` is available as a script
3. Test script validates OCR, extraction, and confidence scoring
4. Test documents README provides clear testing instructions
5. All Phase 3 files exist at expected paths
</verification>

<success_criteria>
- Full document processing pipeline can be tested end-to-end
- Test script validates all four success criteria for Phase 3:
  1. Mistral OCR processes documents and returns text
  2. Structured data extracted from OCR output
  3. Each field has a confidence score
  4. Document Processor agent works as a standalone unit
- Testing setup is documented for manual verification
</success_criteria>

<output>
After completion, create `.planning/phases/03-document-processing/03-06-SUMMARY.md`
</output>
