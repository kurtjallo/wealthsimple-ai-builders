---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/agents/client.ts
  - src/lib/agents/test.ts
  - src/app/api/agents/test/route.ts
  - src/app/api/health/route.ts
autonomous: true

must_haves:
  truths:
    - "Claude Agent SDK client is initialized and can make API calls"
    - "A test endpoint proves the SDK works by getting a response from Claude"
    - "Health check endpoint reports Claude SDK connectivity status"
    - "Agent client is reusable across all future agent implementations"
  artifacts:
    - path: "src/lib/agents/client.ts"
      provides: "Configured Anthropic client singleton"
      contains: "Anthropic"
    - path: "src/app/api/agents/test/route.ts"
      provides: "Test endpoint that calls Claude and returns a response"
      exports: ["POST"]
  key_links:
    - from: "src/lib/agents/client.ts"
      to: "ANTHROPIC_API_KEY"
      via: "environment variable"
      pattern: "process.env.ANTHROPIC_API_KEY"
    - from: "src/app/api/agents/test/route.ts"
      to: "src/lib/agents/client.ts"
      via: "import"
      pattern: "import.*agents/client"
    - from: "src/app/api/health/route.ts"
      to: "src/lib/agents/client.ts"
      via: "import for health check"
      pattern: "import.*agents"
---

<objective>
Set up the Claude Agent SDK (Anthropic SDK) with a reusable client, create a test endpoint that proves SDK connectivity, and update the health check to report Claude API status.

Purpose: Establish the AI backbone that all agents will use. Prove Claude API connectivity before building specialized agents in Phase 2.
Output: Working Anthropic client, test API route returning Claude responses, health check with Claude status.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Anthropic client and test utilities</name>
  <files>src/lib/agents/client.ts, src/lib/agents/test.ts</files>
  <action>
    1. Create `src/lib/agents/client.ts` — Singleton Anthropic client:

       ```typescript
       import Anthropic from "@anthropic-ai/sdk";

       let client: Anthropic | null = null;

       export function getAnthropicClient(): Anthropic {
         if (!client) {
           const apiKey = process.env.ANTHROPIC_API_KEY;
           if (!apiKey) {
             throw new Error("Missing ANTHROPIC_API_KEY environment variable");
           }
           client = new Anthropic({ apiKey });
         }
         return client;
       }

       // Default model configuration for the project
       export const MODEL_CONFIG = {
         // Primary reasoning model
         reasoning: "claude-sonnet-4-6-20250514" as const,
         // Fast routing model
         routing: "claude-haiku-4-5-20251001" as const,
         // Max tokens for standard responses
         maxTokens: 4096,
       } as const;
       ```

       IMPORTANT: Use `claude-sonnet-4-6-20250514` as the model ID (per PROJECT.md: "Claude Sonnet 4.6"). Do NOT use claude-3-5-sonnet or older model IDs. The Anthropic SDK uses the `@anthropic-ai/sdk` package — this was installed in Plan 01.

    2. Create `src/lib/agents/test.ts` — Test utility to verify SDK connectivity:

       ```typescript
       import { getAnthropicClient, MODEL_CONFIG } from "./client";

       export async function testClaudeConnectivity(): Promise<{
         success: boolean;
         model: string;
         response?: string;
         error?: string;
         latencyMs: number;
       }> {
         const start = Date.now();
         try {
           const client = getAnthropicClient();
           const message = await client.messages.create({
             model: MODEL_CONFIG.routing, // Use Haiku for cheap test
             max_tokens: 50,
             messages: [
               {
                 role: "user",
                 content: "Respond with exactly: CONNECTED",
               },
             ],
           });

           const text =
             message.content[0].type === "text" ? message.content[0].text : "";

           return {
             success: true,
             model: message.model,
             response: text.trim(),
             latencyMs: Date.now() - start,
           };
         } catch (e) {
           return {
             success: false,
             model: MODEL_CONFIG.routing,
             error: e instanceof Error ? e.message : "Unknown error",
             latencyMs: Date.now() - start,
           };
         }
       }
       ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `src/lib/agents/client.ts` exports `getAnthropicClient` and `MODEL_CONFIG`
    - `src/lib/agents/test.ts` exports `testClaudeConnectivity`
    - Model IDs use Sonnet 4.6 and Haiku 4.5 (not older claude-3 variants)
  </verify>
  <done>
    Anthropic client singleton and test utility created. Client is reusable across all future agent implementations. Model config centralizes model IDs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create test API route and update health check with Claude status</name>
  <files>src/app/api/agents/test/route.ts, src/app/api/health/route.ts</files>
  <action>
    1. Create `src/app/api/agents/test/route.ts` — Test endpoint that exercises the Claude SDK:

       ```typescript
       import { NextResponse } from "next/server";
       import { testClaudeConnectivity } from "@/lib/agents/test";

       export async function POST() {
         const result = await testClaudeConnectivity();

         return NextResponse.json(result, {
           status: result.success ? 200 : 503,
         });
       }
       ```

    2. Update `src/app/api/health/route.ts` to also check Claude SDK connectivity.

       IMPORTANT: This file was modified by Plan 02 (which runs in parallel). The executor should READ the file first and merge changes. The health check should now check BOTH Supabase AND Claude.

       If Plan 02 has already added Supabase checks, add the Claude check alongside. If Plan 02 hasn't run yet, add both the server check and the Claude check.

       Add to the health check:
       ```typescript
       // Check Claude SDK connectivity
       try {
         const { getAnthropicClient } = await import("@/lib/agents/client");
         getAnthropicClient(); // Validates API key exists
         checks.claude = "ok";
       } catch (e) {
         checks.claude = e instanceof Error ? `error: ${e.message}` : "error: unknown";
       }
       ```

       NOTE: This only checks that the client initializes (API key present). It does NOT make an API call on every health check — that would waste money. The `/api/agents/test` endpoint is for actual connectivity testing.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `curl -X POST http://localhost:3000/api/agents/test` returns JSON with `success: true` (when ANTHROPIC_API_KEY is set)
    - `curl http://localhost:3000/api/health` returns JSON with `checks.claude` field
    - Without API key: test endpoint returns 503 with error message (doesn't crash)
    - With valid API key: test endpoint returns 200 with `success: true`, `model` field, and `response` containing "CONNECTED"
  </verify>
  <done>
    Claude Agent SDK test endpoint working. Health check reports Claude status. SDK responds to API calls when key is configured.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Anthropic client initializes when ANTHROPIC_API_KEY is set
3. `curl -X POST localhost:3000/api/agents/test` returns Claude response with "CONNECTED"
4. Health check at `/api/health` reports both `database` and `claude` status
5. Model IDs use current Claude model versions (Sonnet 4.6, Haiku 4.5)
6. Error handling works — missing API key returns clear error, doesn't crash server
</verification>

<success_criteria>
- Claude Agent SDK initialized and responding to test calls (Phase 1 Success Criterion #3)
- Reusable Anthropic client with centralized model config
- Test endpoint proves end-to-end SDK connectivity
- Health check gives a complete system status (server + database + Claude)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
